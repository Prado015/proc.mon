

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UB PROCUREMENT REQUISITION & PO MONITORING SYSTEM</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    :root {
      --primary-color: #e63946; /* Red */
      --primary-gradient: linear-gradient(135deg, #e63946, #d62838); 
      --secondary-color: #ffffff; /* White */
      --secondary-gradient: linear-gradient(135deg, #f8f9fa, #ffffff);
      --text-color: #1d3557;
      --light-grey: #f8f9fa;
      --border-color: #eaeaea;
      --success: #28a745;
      --success-gradient: linear-gradient(135deg, #28a745, #20c997);
      --warning: #ffc107;
      --warning-gradient: linear-gradient(135deg, #ffc107, #ffbd03);
      --danger: #dc3545;
      --danger-gradient: linear-gradient(135deg, #dc3545, #c82333);
      --info: #17a2b8;
      --info-gradient: linear-gradient(135deg, #17a2b8, #138496);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --transition-speed: 0.3s;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background-color: var(--secondary-color);
      color: var(--text-color);
      overflow-x: hidden;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 250px;
      background-color: white;
      box-shadow: var(--shadow-md);
      transition: all var(--transition-speed);
      z-index: 10;
      position: relative;
    }
    
    .sidebar-header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 3px 10px rgba(230,57,70,0.2);
    }
    
    .sidebar-menu {
      padding: 20px 0;
    }
    
    .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all var(--transition-speed);
      display: flex;
      align-items: center;
      color: var(--text-color);
      position: relative;
      overflow: hidden;
      margin: 4px 8px;
      border-radius: 8px;
    }
    
    .menu-item:before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: var(--primary-gradient);
      opacity: 0;
      transition: all var(--transition-speed);
      z-index: -1;
    }
    
    .menu-item:hover {
      color: var(--primary-color);
      background-color: rgba(230, 57, 70, 0.08);
      transform: translateX(3px);
    }
    
    .menu-item:hover:before {
      opacity: 0.05;
      width: 100%;
    }
    
    .menu-item.active {
      background-color: rgba(230, 57, 70, 0.1);
      color: var(--primary-color);
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }
    
    .menu-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
      transition: transform 0.2s ease;
    }
    
    .menu-item:hover i {
      transform: scale(1.1);
    }
    
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      transition: all var(--transition-speed);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background: var(--secondary-gradient);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    .header h1 {
      font-size: 24px;
      color: var(--primary-color);
      font-weight: 700;
      letter-spacing: -0.5px;
      position: relative;
    }
    
    .header h1:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 40px;
      height: 3px;
      background: var(--primary-gradient);
      border-radius: 5px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      background-color: white;
      padding: 6px 12px;
      border-radius: 50px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      box-shadow: 0 0 0 2px white, 0 0 0 4px rgba(230, 57, 70, 0.2);
      object-fit: cover;
    }
    
    .section {
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      margin-bottom: 25px;
      border: 1px solid var(--border-color);
      transition: all var(--transition-speed);
      position: relative;
      overflow: hidden;
    }
    
    .section:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    
    .section:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: var(--primary-gradient);
      opacity: 0.7;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .section-header h2 {
      font-size: 18px;
      color: var(--primary-color);
      font-weight: 600;
      position: relative;
      padding-left: 15px;
    }
    
    .section-header h2:before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--primary-color);
    }
    
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    
    .btn:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.1);
      transform: translateX(-100%);
      transition: all 0.4s ease;
    }
    
    .btn:hover:before {
      transform: translateX(0);
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }
    
    .btn-primary:hover {
      box-shadow: 0 4px 15px rgba(230, 57, 70, 0.4);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--info-gradient);
      color: white;
    }
    
    .btn-secondary:hover {
      box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: var(--success-gradient);
      color: white;
    }
    
    .btn-success:hover {
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background: var(--danger-gradient);
      color: white;
    }
    
    .btn-danger:hover {
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
      transform: translateY(-2px);
    }
    
    /* Floating Button Styles */
    .btn-float {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-lg);
      position: fixed;
      right: 30px;
      bottom: 30px;
      z-index: 100;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .btn-float:hover {
      transform: translateY(-5px) scale(1.05);
    }
    
    /* Glassmorphism Card Styles */
    .card {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all var(--transition-speed);
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }
    
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 25px;
      margin-bottom: 25px;
    }
    
    .dashboard-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 30px 20px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
      transition: all var(--transition-speed);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.8);
      height: 100%;
    }
    
    .dashboard-card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .dashboard-card i {
      font-size: 40px;
      margin-bottom: 15px;
      color: var(--primary-color);
      background: linear-gradient(135deg, var(--primary-color), #ff8a8a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      transition: transform 0.3s ease;
    }
    
    .dashboard-card:hover i {
      transform: scale(1.1);
    }
    
    .dashboard-card h3 {
      font-size: 28px;
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .dashboard-card p {
      color: #666;
      font-size: 14px;
      font-weight: 500;
      opacity: 0.8;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      background: white;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
    }
    
    table th, table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    table th {
      background: var(--secondary-gradient);
      font-weight: 600;
      color: var(--primary-color);
      position: sticky;
      top: 0;
      z-index: 2;
      box-shadow: 0 2px 3px rgba(0,0,0,0.05);
      white-space: nowrap;
    }
    
    table tr {
      transition: all var(--transition-speed);
    }
    
    table tr:hover {
      background-color: rgba(230, 57, 70, 0.03);
      transform: scale(1.005);
      box-shadow: var(--shadow-sm);
      z-index: 1;
      position: relative;
    }
    
    table tr:last-child td {
      border-bottom: none;
    }
    
    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all var(--transition-speed);
    }
    
    .badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .badge-processing {
      background: var(--warning-gradient);
    }
    
    .badge-ordered {
      background: var(--info-gradient);
    }
    
    .badge-delivered {
      background: var(--success-gradient);
    }
    
    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
      color: #444;
      transition: all 0.3s;
    }
    
    .form-group:focus-within label {
      color: var(--primary-color);
    }
    
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
      background-color: white;
      font-family: 'Inter', sans-serif;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15);
      transform: translateY(-1px);
    }
    
    .form-control::placeholder {
      color: #aaa;
      opacity: 0.7;
    }
    
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%23666' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
      cursor: pointer;
    }
    
    select.form-control:hover {
      border-color: #bbb;
    }
    
    textarea.form-control {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    
    .modal-content {
      background-color: white;
      border-radius: 12px;
      width: 100%;
      max-width: 650px;
      box-shadow: var(--shadow-lg);
      position: relative;
      animation: modalFadeIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-70px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--secondary-gradient);
    }
    
    .modal-header h2 {
      font-size: 18px;
      color: var(--primary-color);
      font-weight: 600;
      position: relative;
      padding-left: 15px;
    }
    
    .modal-header h2:before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 20px;
      border-radius: 3px;
      background: var(--primary-gradient);
    }
    
    .modal-close {
      background: none;
      border: none;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      border-radius: 50%;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background-color: rgba(230, 57, 70, 0.1);
      color: var(--primary-color);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 25px;
      max-height: 70vh;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .modal-footer {
      padding: 18px 25px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background-color: rgba(248, 249, 250, 0.4);
    }
    
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-left: 8px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .action-btn:hover {
      transform: translateY(-3px);
    }
    
    .action-btn.edit {
      color: var(--info);
      background-color: rgba(23, 162, 184, 0.1);
    }
    
    .action-btn.edit:hover {
      color: white;
      background-color: var(--info);
    }
    
    .action-btn.delete {
      color: var(--danger);
      background-color: rgba(220, 53, 69, 0.1);
    }
    
    .action-btn.delete:hover {
      color: white;
      background-color: var(--danger);
    }

    /* Chart styles */
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
    
    /* Tab Styles */
    .tabs {
      display: flex;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border-color);
      gap: 5px;
      position: relative;
      overflow-x: auto;
      scrollbar-width: thin;
      padding-bottom: 2px;
    }
    
    .tabs::-webkit-scrollbar {
      height: 3px;
    }
    
    .tabs::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      transition: all var(--transition-speed);
      font-weight: 500;
      position: relative;
      overflow: hidden;
      border-radius: 8px 8px 0 0;
    }
    
    .tab:before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 3px;
      background: var(--primary-gradient);
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }
    
    .tab:hover:before {
      width: 25px;
    }
    
    .tab:hover {
      background-color: rgba(230, 57, 70, 0.05);
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 600;
      background-color: rgba(230, 57, 70, 0.08);
    }
    
    .tab.active:before {
      width: 100%;
    }

    /* Tab Content Styles with Smooth Transitions */
    .tab-content {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    
    .tab-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
      animation: fadeIn 0.5s ease forwards;
    }
    
    .dashboard-tab-content {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      margin-top: 20px;
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    
    .dashboard-tab-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Page Transitions */
    .page {
      display: none;
      opacity: 0;
      transform: translateX(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    
    .page.active {
      display: block;
      opacity: 1;
      transform: translateX(0);
      animation: pageIn 0.5s ease forwards;
    }
    
    @keyframes pageIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Requisition detail view styles */
    .details-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .details-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .details-table td:first-child {
      width: 35%;
      font-weight: bold;
    }
    
    .item-details-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .item-details-table th {
      background-color: var(--light-grey);
      padding: 10px;
      text-align: left;
      font-weight: bold;
      border-bottom: 2px solid var(--border-color);
    }
    
    .item-details-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .mt-2 {
      margin-top: 10px;
    }
    
    .mt-4 {
      margin-top: 20px;
    }
    
    .req-number-link {
      color: var(--primary-color);
      text-decoration: underline;
      cursor: pointer;
      font-weight: bold;
    }
    
    .req-number-link:hover {
      color: #c1121f;
    }
    
    .item-entry {
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      position: relative;
    }
    
    .remove-item-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .remove-item-btn:hover {
      background: #c82333;
    }
    
    #other-purpose-div {
      transition: all 0.3s ease;
    }

    /* Responsive Layout Improvements */
    @media (max-width: 1200px) {
      .dashboard-cards {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    
    @media (max-width: 992px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        width: 220px;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
      }
      
      .sidebar-menu {
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
        scrollbar-width: thin;
      }
      
      .sidebar-menu::-webkit-scrollbar {
        height: 3px;
      }
      
      .sidebar-menu::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.1);
        border-radius: 10px;
      }
      
      .menu-item {
        padding: 10px 15px;
        margin: 0 5px;
        white-space: nowrap;
        border-radius: 8px;
      }
      
      .menu-item.active {
        border-left: none;
        background-color: rgba(230, 57, 70, 0.1);
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        text-align: center;
      }
      
      .header h1 {
        margin-bottom: 15px;
        font-size: 20px;
      }
      
      .header h1:after {
        left: 50%;
        transform: translateX(-50%);
      }
      
      .tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      
      .btn {
        padding: 8px 16px;
        font-size: 0.75rem;
      }
    }
    
    @media (max-width: 576px) {
      .main-content {
        padding: 15px;
      }
      
      .section {
        padding: 15px;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .section-header > div {
        margin-top: 10px;
        width: 100%;
      }
      
      table th, table td {
        padding: 10px;
      }
      
      .modal-content {
        max-width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <img src="c:\Users\PC\Downloads\ublogo.png" alt="UB Logo" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; object-fit: cover;">
        <h2>UB Procurement</h2>
        <p>Requisition & PO Monitoring</p>
      </div>
      <div class="sidebar-menu">
        <div class="menu-item active" data-page="dashboard" data-role="all">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </div>
        <div class="menu-item" data-page="requisitions" data-role="requester,procurement,admin">
          <i class="fas fa-file-invoice"></i> Requisitions
        </div>
        <div class="menu-item" data-page="suppliers" data-role="procurement,admin">
          <i class="fas fa-truck"></i> Suppliers Management
        </div>
        <div class="menu-item" data-page="reports" data-role="procurement,admin,auditor">
          <i class="fas fa-chart-bar"></i> Reports
        </div>
        <div class="menu-item" data-page="staff" data-role="admin">
          <i class="fas fa-users"></i> Staff
        </div>
        <div class="menu-item" data-page="purchase-orders" data-role="procurement,admin,auditor">
          <i class="fas fa-shopping-cart"></i> Purchase Orders
        </div>
      </div>
      
      <!-- User Profile and Role Selector -->
      <div class="user-profile" style="padding: 15px; border-top: 1px solid #ddd; margin-top: auto;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <img src="c:\Users\PC\Downloads\red logo.png" alt="User"
            style="border-radius: 50%; width: 40px; height: 40px; margin-right: 10px;">
          <div>
            <div id="user-name">Admin User</div>
            <small id="user-email">admin@example.com</small>
          </div>
        </div>
        <div class="form-group">
          <select class="form-control" id="role-selector">
            <option value="admin">Administrator</option>
            <option value="procurement">Procurement Officer</option>
            <option value="requester">Requisition Requester</option>
            <option value="auditor">System Auditor</option>
            <option value="viewer">Viewer (Read-only)</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <h1>UB PROCUREMENT REQUISITION & PO MONITORING SYSTEM</h1>
        <div class="user-info">
          <div>
            <span id="header-user-name">Admin User</span>
            <small id="header-user-role" style="display: block; font-size: 12px; color: #666;">Administrator</small>
          </div>
          <img src="c:\Users\PC\Downloads\red logo.png" alt="User" style="margin-left: 10px;">
        </div>
      </div>
      
      <!-- Dashboard Page -->
      <div class="page active" id="dashboard">
        <div class="section">
          <div class="section-header">
            <h2>Procurement Dashboard</h2>
            <div>
              <select class="form-control" id="dashboard-filter">
                <option value="all">All Time</option>
                <option value="monthly">Monthly Report</option>
                <option value="1st-semester">1st Semester (2024-2025)</option>
                <option value="2nd-semester">2nd Semester (2024-2025)</option>
              </select>
            </div>
          </div>
          
          <div class="tabs">
            <div class="tab active" data-dashboard-tab="overview">Overview</div>
            <div class="tab" data-dashboard-tab="charts">Charts</div>
            <div class="tab" data-dashboard-tab="recent">Recent Requisitions</div>
          </div>
          
          <div class="dashboard-tab-content active" id="overview">
            <div class="dashboard-cards">
              <div class="dashboard-card">
                <i class="fas fa-file-invoice"></i>
                <h3 id="total-requisitions">157</h3>
                <p>Total Requisitions</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-clock"></i>
                <h3 id="pending-requisitions">43</h3>
                <p>Pending Requisitions</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-check-circle"></i>
                <h3 id="delivered-requisitions">98</h3>
                <p>Delivered Items</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-truck"></i>
                <h3 id="active-suppliers">24</h3>
                <p>Active Suppliers</p>
              </div>
            </div>
          </div>
          
          <div class="dashboard-tab-content" id="charts">
            <div class="chart-container">
              <canvas id="requisitionsChart"></canvas>
            </div>
          </div>
          
          <div class="dashboard-tab-content" id="recent">
            <div class="section-header">
              <h2>Recent Requisitions</h2>
              <button class="btn btn-primary" id="createRequisitionBtn">Create New</button>
            </div>
            
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Requisition #</th>
                    <th>Office</th>
                    <th>Type</th>
                    <th>Date Received</th>
                    <th>Purpose</th>
                    <th>Accountable Officer</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="recent-requisitions">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Requisitions Page -->
      <div class="page" id="requisitions">
        <div class="section">
          <div class="section-header">
            <h2>Manage Requisitions</h2>
            <div>
              <button class="btn btn-primary" id="createRequisitionBtn2">Create New</button>
            </div>
          </div>
          
          <div class="tabs">
            <div class="tab active" data-tab="all-requisitions">All Requisitions</div>
            <div class="tab" data-tab="consumable">Consumable</div>
            <div class="tab" data-tab="non-consumable">Non-Consumable</div>
          </div>
          
          <div class="tab-content active" id="all-requisitions">
            <div class="form-group" style="margin-bottom: 20px;">
              <input type="text" class="form-control" id="requisition-search" placeholder="Search requisitions by ID, office, purpose, or officer..." style="max-width: 400px;">
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Requisition #</th>
                    <th>Office</th>
                    <th>Type</th>
                    <th>Date Received</th>
                    <th>Purpose</th>
                    <th>Accountable Officer</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="all-requisitions-table">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="tab-content" id="consumable">
            <div class="form-group" style="margin-bottom: 20px;">
              <input type="text" class="form-control" id="consumable-search" placeholder="Search consumable requisitions..." style="max-width: 400px;">
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Requisition #</th>
                    <th>Office</th>
                    <th>Date Received</th>
                    <th>Purpose</th>
                    <th>Accountable Officer</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="consumable-table">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="tab-content" id="non-consumable">
            <div class="form-group" style="margin-bottom: 20px;">
              <input type="text" class="form-control" id="non-consumable-search" placeholder="Search non-consumable requisitions..." style="max-width: 400px;">
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Requisition #</th>
                    <th>Office</th>
                    <th>Date Received</th>
                    <th>Purpose</th>
                    <th>Accountable Officer</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="non-consumable-table">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Suppliers Page -->
      <div class="page" id="suppliers">
        <div class="section">
          <div class="section-header">
            <h2>Suppliers Management</h2>
            <button class="btn btn-primary" id="addSupplierBtn">Add Supplier</button>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Company Name</th>
                  <th>Contact Person</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>TIN #</th>
                  <th>VAT Status</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="suppliers-table">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Reports Page -->
      <div class="page" id="reports">
        <div class="section">
          <div class="section-header">
            <h2>Reports & Analytics</h2>
            <div>
              <select class="form-control" id="report-type">
                <option value="monthly">Monthly Reports</option>
                <option value="department">By Department</option>
                <option value="status">By Status</option>
                <option value="type">By Type</option>
              </select>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="reportChart"></canvas>
          </div>
          
          <div class="section-header">
            <h2>Monthly Requisitions</h2>
            <div>
              <select class="form-control" id="month-selector">
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
              </select>
            </div>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Requisition #</th>
                  <th>Office</th>
                  <th>Type</th>
                  <th>Date Received</th>
                  <th>Purpose</th>
                  <th>Accountable Officer</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="monthly-requisitions">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Staff Page -->
      <div class="page" id="staff">
        <div class="section">
          <div class="section-header">
            <h2>Staff Management</h2>
          </div>
          
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Position</th>
                  <th>Department</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="staff-table">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Purchase Orders Page -->
      <div class="page" id="purchase-orders">
        <div class="section">
          <div class="section-header">
            <h2>Purchase Order Monitoring</h2>
            <div>
              <button class="btn btn-primary" id="createPurchaseOrderBtn">Create New PO</button>
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <input type="text" class="form-control" id="purchase-order-search" placeholder="Search purchase orders by PO#, supplier, or requisition..." style="max-width: 400px;">
          </div>
          
          <div class="tabs">
            <div class="tab active" data-po-tab="po-list">Purchase Orders List</div>
            <div class="tab" data-po-tab="delivery-tracker">Delivery Tracker</div>
            <div class="tab" data-po-tab="delivery-performance">Delivery Performance</div>
            <div class="tab" data-po-tab="audit-dashboard">Audit Dashboard</div>
          </div>
          
          <div class="tab-content active" id="po-list">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>PO #</th>
                    <th>Supplier Name</th>
                    <th>Date Ordered</th>
                    <th>Requisition #</th>
                    <th>Date Delivered</th>
                    <th>Date Needed</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="purchase-orders-table">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="tab-content" id="delivery-tracker">
            <div class="section-header">
              <h3>Delivery Performance Tracker</h3>
              <div>
                <select class="form-control" id="delivery-filter">
                  <option value="all">All POs</option>
                  <option value="delivered">Delivered Only</option>
                  <option value="pending">Pending Only</option>
                  <option value="delayed">Delayed Only</option>
                </select>
              </div>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>PO #</th>
                    <th>Supplier</th>
                    <th>Date Ordered</th>
                    <th>Date Needed</th>
                    <th>Estimated Delivery</th>
                    <th>Actual Delivery</th>
                    <th>Lead Time</th>
                    <th>Delay</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="delivery-tracker-table">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="tab-content" id="delivery-performance">
            <div class="section-header">
              <h2>Delivery Performance Metrics</h2>
              <div>
                <select class="form-control" id="performance-filter">
                  <option value="all">All Time</option>
                  <option value="year">This Year</option>
                  <option value="quarter">This Quarter</option>
                  <option value="month">This Month</option>
                </select>
              </div>
            </div>
            
            <div class="dashboard-cards">
              <div class="dashboard-card">
                <i class="fas fa-check-circle"></i>
                <h3 id="on-time-percentage">87%</h3>
                <p>On-Time Delivery Rate</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-clock"></i>
                <h3 id="avg-lead-time">14</h3>
                <p>Avg. Lead Time (days)</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="late-deliveries">12</h3>
                <p>Late Deliveries</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-star"></i>
                <h3 id="top-supplier">ABC Ltd</h3>
                <p>Top Performing Supplier</p>
              </div>
            </div>
            
            <div class="section">
              <div class="section-header">
                <h2>Performance Tracking</h2>
              </div>
              
              <div class="tabs">
                <div class="tab active" data-performance-tab="monthly-trend">Monthly Trend</div>
                <div class="tab" data-performance-tab="supplier-comparison">Supplier Comparison</div>
                <div class="tab" data-performance-tab="department-metrics">Department Metrics</div>
              </div>
              
              <div class="tab-content active" id="monthly-trend">
                <div class="chart-container">
                  <canvas id="monthlyPerformanceChart"></canvas>
                </div>
              </div>
              
              <div class="tab-content" id="supplier-comparison">
                <div class="chart-container">
                  <canvas id="supplierComparisonChart"></canvas>
                </div>
              </div>
              
              <div class="tab-content" id="department-metrics">
                <div class="chart-container">
                  <canvas id="departmentMetricsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <div class="tab-content" id="audit-dashboard">
            <div class="dashboard-cards">
              <div class="dashboard-card">
                <i class="fas fa-check-circle"></i>
                <h3 id="ontime-percentage">0%</h3>
                <p>On-Time Deliveries</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-clock"></i>
                <h3 id="avg-lead-time">0 days</h3>
                <p>Avg. Lead Time</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="longest-delay">0 days</h3>
                <p>Longest Delay</p>
              </div>
              <div class="dashboard-card">
                <i class="fas fa-truck-loading"></i>
                <h3 id="pending-deliveries">0</h3>
                <p>Pending Deliveries</p>
              </div>
            </div>
            
            <div class="form-grid" style="margin-top: 20px;">
              <div class="form-group">
                <label for="audit-filter-dept">Filter by Department</label>
                <select class="form-control" id="audit-filter-dept">
                  <option value="all">All Departments</option>
                  <!-- Populated by JavaScript -->
                </select>
              </div>
              <div class="form-group">
                <label for="audit-filter-supplier">Filter by Supplier</label>
                <select class="form-control" id="audit-filter-supplier">
                  <option value="all">All Suppliers</option>
                  <!-- Populated by JavaScript -->
                </select>
              </div>
              <div class="form-group">
                <label for="audit-filter-date">Filter by Date Range</label>
                <select class="form-control" id="audit-filter-date">
                  <option value="all">All Time</option>
                  <option value="month">Current Month</option>
                  <option value="quarter">Current Quarter</option>
                  <option value="year">Current Year</option>
                </select>
              </div>
              <div class="form-group">
                <label for="audit-filter-compliance">Compliance Filter</label>
                <select class="form-control" id="audit-filter-compliance">
                  <option value="all">All POs</option>
                  <option value="compliant">Compliant Only</option>
                  <option value="non-compliant">Non-Compliant Only</option>
                </select>
              </div>
            </div>
            
            <div class="chart-container" style="margin-top: 20px;">
              <canvas id="auditChart"></canvas>
            </div>
            
            <div class="tabs" style="margin-top: 20px;">
              <div class="tab active" data-audit-chart="delivery-performance">Delivery Performance</div>
              <div class="tab" data-audit-chart="compliance-trends">Compliance Trends</div>
              <div class="tab" data-audit-chart="lead-time">Lead Time Analysis</div>
              <div class="tab" data-audit-chart="document-status">Document Completeness</div>
            </div>
            
            <div class="audit-chart-container chart-container" style="margin-top: 15px; height: 350px;">
              <canvas id="auditDetailChart"></canvas>
            </div>
            
            <div class="section-header" style="margin-top: 20px;">
              <h3>Compliance Analytics</h3>
              <div>
                <button class="btn btn-secondary" id="export-audit-data">
                  <i class="fas fa-file-export"></i> Export Data
                </button>
              </div>
            </div>
            
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>PO #</th>
                    <th>Department</th>
                    <th>Supplier</th>
                    <th>Target Date</th>
                    <th>Actual Date</th>
                    <th>Variance (Days)</th>
                    <th>Within Threshold</th>
                    <th>Documents Complete</th>
                  </tr>
                </thead>
                <tbody id="compliance-table">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            
            <!-- Export Options Modal -->
            <div class="modal" id="exportModal">
              <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                  <h2>Export Audit Data</h2>
                  <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="export-format">Export Format</label>
                    <select class="form-control" id="export-format">
                      <option value="csv">CSV File</option>
                      <option value="excel">Excel File</option>
                      <option value="pdf">PDF Report</option>
                      <option value="json">JSON Data</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="export-content">Content to Export</label>
                    <select class="form-control" id="export-content">
                      <option value="current">Currently Filtered Data</option>
                      <option value="all">All Audit Data</option>
                      <option value="summary">Summary Reports Only</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label>Include Charts</label>
                    <div style="margin-top: 10px;">
                      <input type="checkbox" id="export-include-charts" checked>
                      <label for="export-include-charts" style="display: inline; margin-left: 8px;">Include visualization charts in export</label>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="export-filename">File Name</label>
                    <input type="text" class="form-control" id="export-filename" placeholder="audit_report" value="audit_report">
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-primary" id="download-export-btn">Download</button>
                  <button class="btn" id="cancel-export-btn">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Create Requisition Modal -->
  <div class="modal" id="requisitionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Requisition</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="requisitionForm">
          <div class="form-group">
            <label for="req-id">Requisition # (optional)</label>
            <input type="text" class="form-control" id="req-id" placeholder="Enter requisition number or leave blank for auto-generation">
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="req-office">Office</label>
              <select class="form-control" id="req-office" required>
                <option value="">Select Office</option>
               <option value="ARC">ARC</option>
                <option value="ATHLETICS">ATHLETICS</option>
                <option value="BOARDROOM">BOARDROOM</option>
                <option value="CASHIER">CASHIER</option>
                <option value="CCSD">CCSD</option>
                <option value="CPDO">CPDO</option>
                <option value="CSR">CSR</option>
                <option value="DISBURING">DISBURING</option>
                <option value="DENTAL CLINIC">DENTAL CLINIC</option>
                <option value="DENTAL INFIRMARY">DENTAL INFIRMARY</option>
                <option value="ELECTRICAL">ELECTRICAL</option>
                <option value="HRMC">HRMC</option>
                <option value="INVENTORY">INVENTORY</option>
                <option value="LIBRARY">LIBRARY</option>
                <option value="LINKAGES">LINKAGES</option>
                <option value="MEDICAL CLINIC">MEDICAL CLINIC</option>
                <option value="MIS">MIS</option>
                <option value="NAKTAYNAY">NAKTAYNAY</option>
                <option value="OSA">OSA</option>
                <option value="PAYROLL">PAYROLL</option>  
                <option value="PRESIDENTS OFFICE">PRESIDENTS OFFICE</option>
                <option value="PROCUREMENT">PROCUREMENT</option>
                <option value="PT CLINIC">PT CLINIC</option>
                <option value="QAO">QAO</option>             
                <option value="RIECO">RIECO</option>
                <option value="RISK MANAGEMENT">RISK MANAGEMENT</option>
                <option value="SAO">SAO</option>
                <option value="SBAA DEANS">SBAA DEANS</option>
                <option value="SCJPS DEANS">SCJPS DEANS</option>
                <option value="SECURITY">SECURITY</option>
                <option value="SEA DEANS">SEA DEANS</option>
                <option value="SIT DEANS">SIT DEANS</option>
                <option value="SIHTM KITCHEN">SIHTM KITCHEN</option>
                <option value="SIHTM STOCKROOM">SIHTM STOCKROOM</option>
                <option value="SNS DEANS">SNS DEANS</option>
                <option value="SOD DEANS">SOD DEANS</option>
                <option value="SOL DEANS">SOL DEANS</option>
                <option value="SMART AVR">SMART AVR</option>
                <option value="STELA DEANS">STELA DEANS</option>
                <option value="UB LES">UB LES</option>
                <option value="UBHS">UBHS</option>
                <option value="UBSCI-HS">UBSCI-HS</option>
                <option value="VP ACAD">VP ACAD</option>
                <option value="VP ADMIN">VP ADMIN</option>
                <option value="VP FINANCE">VP FINANCE</option>
              </select>
            </div>
            <div class="form-group">
              <label for="req-type">Requisition Type</label>
              <select class="form-control" id="req-type" required>
                <option value="">Select Type</option>
                <option value="Consumable">Consumable</option>
                <option value="Non-Consumable">Non-Consumable</option>
              </select>
            </div>
            <div class="form-group">
              <label for="req-quantity">Quantity</label>
              <input type="number" class="form-control" id="req-quantity" min="1" required>
            </div>
            <div class="form-group">
              <label for="req-date">Date Received</label>
              <input type="date" class="form-control" id="req-date" required>
            </div>
            <div class="form-group">
              <label for="req-purpose">Purpose</label>
              <select class="form-control" id="req-purpose" required onchange="toggleOtherPurpose()">
                <option value="">Select Purpose</option>
                <option value="Office Use">Office Use</option>
                <option value="Laboratory Use">Laboratory Use</option>
                <option value="CPDO Development">CPDO Development</option>
                <option value="Library Development">Library Development</option>
                <option value="Dentistry Development">Dentistry Development</option>
                <option value="Others (FOR HALL WAYS OF UB CAMPUS)">Others (FOR HALL WAYS OF UB CAMPUS)</option>
                <option value="Others">Others</option>
              </select>
            </div>
            <div class="form-group" id="other-purpose-div" style="display: none;">
              <label for="req-other-purpose">Specify Other Purpose</label>
              <input type="text" class="form-control" id="req-other-purpose" placeholder="Please specify purpose">
            </div>
            <div class="form-group">
              <label for="req-officer">Accountable Officer</label>
              <input type="text" class="form-control" id="req-officer" required placeholder="Enter name of accountable officer">
            </div>
            <div class="form-group">
              <label for="req-status">Status</label>
              <select class="form-control" id="req-status" required>
                <option value="Still Processing">Still Processing</option>
                <option value="Ordered">Ordered</option>
                <option value="Delivered">Delivered</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div class="form-group">
              <label for="req-staff-in-charge">Staff in Charge</label>
              <select class="form-control" id="req-staff-in-charge" required>
                <option value="">Select Staff in Charge</option>
                <option value="CASTILLO, MARK IAN">CASTILLO, MARK IAN</option>
                <option value="EGUID, RUBIE ANN T. PADIERNOS">EGUID, RUBIE ANN T. PADIERNOS</option>
                <option value="FLORES, MYLES O. TAMO">FLORES, MYLES O. TAMO</option>
                <option value="QUITLONG, FERDINAND B.">QUITLONG, FERDINAND B.</option>
                <option value="VELASQUEZ, VIOLY ANN D.">VELASQUEZ, VIOLY ANN D.</option>
                <option value="VISITACION, JEVERT E.">VISITACION, JEVERT E.</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="req-date-requested">Date Requested</label>
            <input type="date" class="form-control" id="req-date-requested">
          </div>
          <div class="form-group">
            <label for="req-description">Additional Description</label>
            <textarea class="form-control" id="req-description"></textarea>
          </div>
          <div id="items-container">
            <div class="item-entry">
              <div class="form-group">
                <label for="req-item-name-0">Item Name & Specifications</label>
                <input type="text" class="form-control" id="req-item-name-0">
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="req-item-qty-0">Quantity/Unit</label>
                  <input type="text" class="form-control" id="req-item-qty-0">
                </div>
                <div class="form-group">
                  <label for="req-item-brand-0">Brand/Model</label>
                  <input type="text" class="form-control" id="req-item-brand-0">
                </div>
              </div>
              <div class="form-group">
                <label for="req-item-assigned-0">Assigned To</label>
                <select class="form-control" id="req-item-assigned-0">
                  <option value="">Not Assigned</option>
                  <option value="CASTILLO, MARK IAN">CASTILLO, MARK IAN</option>
                  <option value="EGUID, RUBIE ANN T. PADIERNOS">EGUID, RUBIE ANN T. PADIERNOS</option>
                  <option value="FLORES, MYLES O. TAMO">FLORES, MYLES O. TAMO</option>
                  <option value="QUITLONG, FERDINAND B.">QUITLONG, FERDINAND B.</option>
                  <option value="VELASQUEZ, VIOLY ANN D.">VELASQUEZ, VIOLY ANN D.</option>
                  <option value="VISITACION, JEVERT E.">VISITACION, JEVERT E.</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-group">
            <button type="button" class="btn btn-primary" id="add-item-btn">
              <i class="fas fa-plus"></i> Add Another Item
            </button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveRequisitionBtn">Save</button>
        <button class="btn" id="cancelRequisitionBtn">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- View Requisition Details Modal -->
  <div class="modal" id="viewRequisitionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>REQUISITION INFORMATION</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <table class="details-table">
          <tr>
            <td><strong>Requisition Number:</strong></td>
            <td id="detail-req-number"></td>
          </tr>
          <tr>
            <td><strong>Date Requested:</strong></td>
            <td id="detail-date-requested"></td>
          </tr>
          <tr>
            <td><strong>Accountable Officer:</strong></td>
            <td id="detail-accountable-officer"></td>
          </tr>
          <tr>
            <td><strong>Office:</strong></td>
            <td id="detail-office"></td>
          </tr>
          <tr>
            <td><strong>Purpose:</strong></td>
            <td id="detail-purpose"></td>
          </tr>
          <tr>
            <td><strong>Request Type:</strong></td>
            <td id="detail-request-type"></td>
          </tr>
          <tr>
            <td><strong>Date Received (RS):</strong></td>
            <td id="detail-date-received"></td>
          </tr>
        </table>
        
        <h3 class="mt-4">Item Details</h3>
        <div class="table-container">
          <table class="item-details-table">
            <thead>
              <tr>
                <th>#</th>
                <th>ITEM NAME & SPECIFICATIONS</th>
                <th>QTY/UNIT</th>
                <th>BRAND/MODEL</th>
                <th>ASSIGNED</th>
                <th>OTHER DETAILS</th>
              </tr>
            </thead>
            <tbody id="item-details-body">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
        <p id="item-count" class="mt-2"></p>
      </div>
    </div>
  </div>
  
  <!-- Add Supplier Modal -->
  <div class="modal" id="supplierModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Supplier</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="supplierForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="supplier-company">Company Name</label>
              <input type="text" class="form-control" id="supplier-company" required>
            </div>
            <div class="form-group">
              <label for="supplier-contact">Contact Person</label>
              <input type="text" class="form-control" id="supplier-contact" required>
            </div>
            <div class="form-group">
              <label for="supplier-email">Email</label>
              <input type="email" class="form-control" id="supplier-email" required>
            </div>
            <div class="form-group">
              <label for="supplier-phone">Phone</label>
              <input type="text" class="form-control" id="supplier-phone" required>
            </div>
            <div class="form-group">
              <label for="supplier-tin">TIN Number</label>
              <input type="text" class="form-control" id="supplier-tin" placeholder="000-000-000-000" required>
            </div>
            <div class="form-group">
              <label for="supplier-vat">VAT Status</label>
              <select class="form-control" id="supplier-vat" required>
                <option value="">Select VAT Status</option>
                <option value="VAT">VAT</option>
                <option value="Non-VAT">Non-VAT</option>
              </select>
            </div>
            <div class="form-group">
              <label for="supplier-category">Category</label>
              <select class="form-control" id="supplier-category" required>
                <option value="">Select Category</option>
                <option value="Office Supplies">Office Supplies</option>
                <option value="IT Equipment">IT Equipment</option>
                <option value="Furniture">Furniture</option>
                <option value="Consumables">Consumables</option>
                <option value="Services">Services</option>
              </select>
            </div>
            <div class="form-group">
              <label for="supplier-status">Status</label>
              <select class="form-control" id="supplier-status" required>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveSupplierBtn">Save</button>
        <button class="btn" id="cancelSupplierBtn">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Create Purchase Order Modal -->
  <div class="modal" id="purchaseOrderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Purchase Order</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="purchaseOrderForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="po-supplier">Supplier Name</label>
              <div class="form-check" style="margin-bottom: 5px;">
                <input type="checkbox" class="form-check-input" id="use-manual-supplier" onchange="populateSupplierDropdown()">
                <label class="form-check-label" for="use-manual-supplier">Enter supplier manually</label>
              </div>
              <select class="form-control" id="po-supplier">
                <option value="">Select Supplier</option>
                <!-- Populated by JavaScript -->
              </select>
              <input type="text" class="form-control" id="po-manual-supplier" placeholder="Enter supplier name" style="display: none;">
            </div>
            <div class="form-group">
              <label for="po-number">PO Number (optional)</label>
              <input type="text" class="form-control" id="po-number" placeholder="Leave blank for auto-generation">
            </div>
            <div class="form-group">
              <label for="po-date-ordered">Date Ordered</label>
              <input type="date" class="form-control" id="po-date-ordered" required>
            </div>
            <div class="form-group">
              <label for="po-requisition">Requisition #</label>
              <div class="form-check" style="margin-bottom: 5px;">
                <input type="checkbox" class="form-check-input" id="use-manual-requisition" onchange="toggleManualRequisition()">
                <label class="form-check-label" for="use-manual-requisition">Enter requisition manually</label>
              </div>
              <div id="requisition-selection-container">
                <div class="requisition-entry">
                  <select class="form-control" id="po-requisition">
                    <option value="">Select Requisition</option>
                    <!-- Populated by JavaScript -->
                  </select>
                  <input type="text" class="form-control" id="po-manual-requisition" placeholder="Enter requisition ID" style="display: none;">
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-primary" id="add-requisition-btn" style="margin-top: 10px;">
                <i class="fas fa-plus"></i> Add Another Requisition
              </button>
            </div>
            <div class="form-group">
              <label for="po-date-needed">Date Needed</label>
              <div id="delivery-dates-container">
                <div class="delivery-date-entry">
                  <input type="date" class="form-control" id="po-date-needed" required>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-primary" id="add-delivery-date-btn" style="margin-top: 10px;">
                <i class="fas fa-plus"></i> Add Another Delivery Date
              </button>
            </div>
            <div class="form-group">
              <label for="po-status">Status</label>
              <select class="form-control" id="po-status" required>
                <option value="Pending">Pending</option>
                <option value="Ordered">Ordered</option>
                <option value="Partially Delivered">Partially Delivered</option>
                <option value="Delivered">Delivered</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="po-date-delivered">Date Delivered (optional)</label>
            <input type="date" class="form-control" id="po-date-delivered">
          </div>
          <div class="form-group">
            <label for="po-estimated-delivery">Estimated Delivery Date</label>
            <input type="date" class="form-control" id="po-estimated-delivery">
          </div>
          <div class="form-group">
            <label for="po-procurement-mode">Mode of Payment</label>
            <select class="form-control" id="po-procurement-mode">
              <option value="">Select Mode</option>
              <option value="Check Payable to the Purchasing Staff">Check Payable to the Purchasing Staff</option>
              <option value="Bank-to-Bank">Bank-to-Bank</option>
              <option value="50% Down Payment/50% Full Payment">50% Down Payment/50% Full Payment</option>
              <option value="Petty Cash">Petty Cash</option>
            </select>
          </div>
          
          <div class="form-group" id="department-manual-input" style="display: none;">
            <label for="po-department">Department</label>
            <input type="text" class="form-control" id="po-department" placeholder="Enter department">
          </div>
          <div class="form-group">
            <label for="po-receiving-officer">Receiving Officer</label>
            <select class="form-control" id="po-receiving-officer">
              <option value="">Select Receiving Officer</option>
              <!-- Populated by JavaScript from staffData -->
            </select>
          </div>
          <div class="form-group">
            <label for="po-notes">Notes</label>
            <textarea class="form-control" id="po-notes" placeholder="Additional notes or comments"></textarea>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="savePurchaseOrderBtn">Save</button>
        <button class="btn" id="cancelPurchaseOrderBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://lib.youware.com/youware-lib-editor.1754557047.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib-editor.1752562065.js" id="yourware-lib"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Empty requisition data array - allowing users to input all upcoming requisitions
    const requisitionData = [];
    
    // Purchase Orders data array
    const purchaseOrderData = [];

    const supplierData = [
      {
        company: "Office Essentials Co.",
        contact: "John Smith",
        email: "john@officeessentials.com",
        phone: "123-456-7890",
        tin: "123-456-789-001",
        vat: "VAT",
        category: "Office Supplies",
        status: "Active"
      },
      {
        company: "Tech Solutions Inc.",
        contact: "Sarah Johnson",
        email: "sarah@techsolutions.com",
        phone: "234-567-8901",
        tin: "234-567-890-002",
        vat: "VAT",
        category: "IT Equipment",
        status: "Active"
      },
      {
        company: "Furniture Plus",
        contact: "Michael Brown",
        email: "michael@furnitureplus.com",
        phone: "345-678-9012",
        tin: "345-678-901-003",
        vat: "Non-VAT",
        category: "Furniture",
        status: "Active"
      },
      {
        company: "Consumable Goods Ltd.",
        contact: "Jessica Davis",
        email: "jessica@consumablegoods.com",
        phone: "456-789-0123",
        tin: "456-789-012-004",
        vat: "VAT",
        category: "Consumables",
        status: "Active"
      },
      {
        company: "Service Providers Co.",
        contact: "Robert Wilson",
        email: "robert@serviceproviders.com",
        phone: "567-890-1234",
        tin: "567-890-123-005",
        vat: "Non-VAT",
        category: "Services",
        status: "Inactive"
      }
    ];

    const staffData = [
      {
        name: "MYLES TAMO FLORES",
        position: "Procurement Officer",
        department: "Procurement",
        email: "myles@example.com",
        phone: "123-456-7890"
      },
      {
        name: "CASTILLO MARK IAN",
        position: "Procurement Specialist",
        department: "Procurement",
        email: "mark@example.com",
        phone: "234-567-8901"
      },
      {
        name: "EGUID RUBIE ANN",
        position: "Procurement Assistant",
        department: "Procurement",
        email: "rubie@example.com",
        phone: "345-678-9012"
      },
      {
        name: "QUITLONG FERDIE",
        position: "Procurement Manager",
        department: "Procurement",
        email: "ferdie@example.com",
        phone: "456-789-0123"
      },
      {
        name: "VELASQUEZ VIOLY ANN",
        position: "Procurement Coordinator",
        department: "Procurement",
        email: "violy@example.com",
        phone: "567-890-1234"
      },
      {
        name: "VISITACION JEVERT",
        position: "Procurement Analyst",
        department: "Procurement",
        email: "jevert@example.com",
        phone: "678-901-2345"
      }
    ];

    // DOM elements
    const pages = document.querySelectorAll('.page');
    const menuItems = document.querySelectorAll('.menu-item');
    const tabs = document.querySelectorAll('.tab[data-tab]');
    const dashboardTabs = document.querySelectorAll('.tab[data-dashboard-tab]');
    const tabContents = document.querySelectorAll('.tab-content');
    const dashboardTabContents = document.querySelectorAll('.dashboard-tab-content');
    const createRequisitionBtns = document.querySelectorAll('#createRequisitionBtn, #createRequisitionBtn2');
    const addSupplierBtn = document.getElementById('addSupplierBtn');
    const createPurchaseOrderBtn = document.getElementById('createPurchaseOrderBtn');
    const requisitionModal = document.getElementById('requisitionModal');
    const viewRequisitionModal = document.getElementById('viewRequisitionModal');
    const supplierModal = document.getElementById('supplierModal');
    const purchaseOrderModal = document.getElementById('purchaseOrderModal');
    const closeButtons = document.querySelectorAll('.modal-close');
    const cancelRequisitionBtn = document.getElementById('cancelRequisitionBtn');
    const cancelSupplierBtn = document.getElementById('cancelSupplierBtn');
    const cancelPurchaseOrderBtn = document.getElementById('cancelPurchaseOrderBtn');
    const saveRequisitionBtn = document.getElementById('saveRequisitionBtn');
    const saveSupplierBtn = document.getElementById('saveSupplierBtn');
    const savePurchaseOrderBtn = document.getElementById('savePurchaseOrderBtn');
    const monthSelector = document.getElementById('month-selector');
    const reportType = document.getElementById('report-type');
    const dashboardFilter = document.getElementById('dashboard-filter');
    
    // Page Navigation
    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        const pageId = item.getAttribute('data-page');
        
        // Hide all pages
        pages.forEach(page => {
          page.classList.remove('active');
        });
        
        // Show selected page
        document.getElementById(pageId).classList.add('active');
        
        // Update active menu item
        menuItems.forEach(menuItem => {
          menuItem.classList.remove('active');
        });
        
        item.classList.add('active');
      });
    });
    
    // Tab Navigation
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        
        // Hide all tab contents
        tabContents.forEach(content => {
          content.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabId).classList.add('active');
        
        // Update active tab
        tabs.forEach(t => {
          t.classList.remove('active');
        });
        
        tab.classList.add('active');
      });
    });
    
    // Dashboard Tab Navigation
    dashboardTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-dashboard-tab');
        
        // Hide all dashboard tab contents
        dashboardTabContents.forEach(content => {
          content.classList.remove('active');
        });
        
        // Show selected dashboard tab content
        document.getElementById(tabId).classList.add('active');
        
        // Update active dashboard tab
        dashboardTabs.forEach(t => {
          t.classList.remove('active');
        });
        
        tab.classList.add('active');
      });
    });
    
    // Modal Functions
    function openModal(modal) {
      modal.style.display = 'flex';
    }
    
    function closeModal(modal) {
      modal.style.display = 'none';
    }
    
    // Open Modals
    createRequisitionBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Reset items container to original state when opening the modal
        const itemsContainer = document.getElementById('items-container');
        itemsContainer.innerHTML = `
          <div class="item-entry">
            <div class="form-group">
              <label for="req-item-name-0">Item Name & Specifications</label>
              <input type="text" class="form-control" id="req-item-name-0">
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="req-item-qty-0">Quantity/Unit</label>
                <input type="text" class="form-control" id="req-item-qty-0">
              </div>
              <div class="form-group">
                <label for="req-item-brand-0">Brand/Model</label>
                <input type="text" class="form-control" id="req-item-brand-0">
              </div>
            </div>
          </div>
        `;
        itemCounter = 1;
        openModal(requisitionModal);
      });
    });
    
    addSupplierBtn.addEventListener('click', () => openModal(supplierModal));
    
    createPurchaseOrderBtn.addEventListener('click', () => {
      populateSupplierDropdown();
      populateRequisitionDropdown();
      openModal(purchaseOrderModal);
    });
    
    // Close Modals
    closeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        closeModal(requisitionModal);
        closeModal(supplierModal);
        closeModal(viewRequisitionModal);
        closeModal(purchaseOrderModal);
      });
    });
    
    cancelRequisitionBtn.addEventListener('click', () => closeModal(requisitionModal));
    cancelSupplierBtn.addEventListener('click', () => closeModal(supplierModal));
    cancelPurchaseOrderBtn.addEventListener('click', () => closeModal(purchaseOrderModal));
    
    // View Requisition Details
    function viewRequisitionDetails(id) {
      const requisition = requisitionData.find(req => req.id === id);
      
      if (requisition) {
        // Populate the requisition details
        document.getElementById('detail-req-number').textContent = requisition.id;
        document.getElementById('detail-date-requested').textContent = formatDate(requisition.dateRequested);
        document.getElementById('detail-accountable-officer').textContent = requisition.accountableOfficer;
        document.getElementById('detail-office').textContent = requisition.office;
        document.getElementById('detail-purpose').textContent = requisition.purpose;
        document.getElementById('detail-request-type').textContent = requisition.type;
        document.getElementById('detail-date-received').textContent = requisition.dateReceived;
        
        // Populate the item details table
        const itemDetailsBody = document.getElementById('item-details-body');
        itemDetailsBody.innerHTML = '';
        
        if (requisition.items && requisition.items.length > 0) {
          requisition.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.id}</td>
              <td>${item.name}</td>
              <td>${item.quantity}</td>
              <td>${item.brand}</td>
              <td>${item.assigned}</td>
              <td>${item.otherDetails}</td>
            `;
            itemDetailsBody.appendChild(row);
          });
          
          document.getElementById('item-count').textContent = `# of Items: ${requisition.items.length}`;
        } else {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="6" style="text-align: center;">No items found</td>';
          itemDetailsBody.appendChild(row);
          
          document.getElementById('item-count').textContent = '# of Items: 0';
        }
        
        // Open the modal
        openModal(viewRequisitionModal);
      }
    }
    
    // Global variable to track if we're in edit mode
    let editingRequisitionId = null;
    
    // Function to reset the requisition form
    function resetRequisitionForm() {
      document.getElementById('requisitionForm').reset();
      editingRequisitionId = null;
      
      // Reset modal title
      document.querySelector('#requisitionModal .modal-header h2').textContent = 'Create New Requisition';
      
      // Reset items container to original state
      const itemsContainer = document.getElementById('items-container');
      itemsContainer.innerHTML = `
        <div class="item-entry">
          <div class="form-group">
            <label for="req-item-name-0">Item Name & Specifications</label>
            <input type="text" class="form-control" id="req-item-name-0">
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="req-item-qty-0">Quantity/Unit</label>
              <input type="text" class="form-control" id="req-item-qty-0">
            </div>
            <div class="form-group">
              <label for="req-item-brand-0">Brand/Model</label>
              <input type="text" class="form-control" id="req-item-brand-0">
            </div>
          </div>
          <div class="form-group">
            <label for="req-item-assigned-0">Assigned To</label>
            <select class="form-control" id="req-item-assigned-0">
              <option value="">Not Assigned</option>
              <option value="CASTILLO, MARK IAN">CASTILLO, MARK IAN</option>
              <option value="EGUID, RUBIE ANN T. PADIERNOS">EGUID, RUBIE ANN T. PADIERNOS</option>
              <option value="FLORES, MYLES O. TAMO">FLORES, MYLES O. TAMO</option>
              <option value="QUITLONG, FERDINAND B.">QUITLONG, FERDINAND B.</option>
              <option value="VELASQUEZ, VIOLY ANN D.">VELASQUEZ, VIOLY ANN D.</option>
              <option value="VISITACION, JEVERT E.">VISITACION, JEVERT E.</option>
            </select>
          </div>
        </div>
      `;
      
      // Hide other purpose field if visible
      document.getElementById('other-purpose-div').style.display = 'none';
      
      itemCounter = 1;
    }
    
    // Function to edit a requisition
    function editRequisition(id) {
      const requisition = requisitionData.find(req => req.id === id);
      
      if (requisition) {
        editingRequisitionId = id;
        
        // Update modal title
        document.querySelector('#requisitionModal .modal-header h2').textContent = 'Edit Requisition';
        
        // Fill form with requisition data
        document.getElementById('req-id').value = requisition.id;
        document.getElementById('req-office').value = requisition.office;
        document.getElementById('req-type').value = requisition.type;
        document.getElementById('req-quantity').value = requisition.quantity;
        document.getElementById('req-date').value = requisition.dateReceived;
        document.getElementById('req-date-requested').value = requisition.dateRequested;
        document.getElementById('req-officer').value = requisition.accountableOfficer;
        document.getElementById('req-staff-in-charge').value = requisition.staffInCharge || '';
        document.getElementById('req-status').value = requisition.status;
        document.getElementById('req-purpose').value = 'Others';
        toggleOtherPurpose();
        document.getElementById('req-other-purpose').value = requisition.purpose;
        document.getElementById('req-description').value = requisition.description || '';
        
        // Set up items
        const itemsContainer = document.getElementById('items-container');
        itemsContainer.innerHTML = '';
        
        if (requisition.items && requisition.items.length > 0) {
          requisition.items.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-entry';
            
            if (index > 0) {
              itemDiv.innerHTML = `
                <button type="button" class="remove-item-btn" onclick="removeItem(this)">
                  <i class="fas fa-times"></i>
                </button>
              `;
            }
            
            itemDiv.innerHTML += `
              <div class="form-group">
                <label for="req-item-name-${index}">Item Name & Specifications</label>
                <input type="text" class="form-control" id="req-item-name-${index}" value="${item.name}">
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="req-item-qty-${index}">Quantity/Unit</label>
                  <input type="text" class="form-control" id="req-item-qty-${index}" value="${item.quantity}">
                </div>
                <div class="form-group">
                  <label for="req-item-brand-${index}">Brand/Model</label>
                  <input type="text" class="form-control" id="req-item-brand-${index}" value="${item.brand || ''}">
                </div>
              </div>
              <div class="form-group">
                <label for="req-item-assigned-${index}">Assigned To</label>
                <select class="form-control" id="req-item-assigned-${index}">
                  <option value="">Not Assigned</option>
                  <option value="CASTILLO, MARK IAN" ${item.assigned === 'CASTILLO, MARK IAN' ? 'selected' : ''}>CASTILLO, MARK IAN</option>
                  <option value="EGUID, RUBIE ANN T. PADIERNOS" ${item.assigned === 'EGUID, RUBIE ANN T. PADIERNOS' ? 'selected' : ''}>EGUID, RUBIE ANN T. PADIERNOS</option>
                  <option value="FLORES, MYLES O. TAMO" ${item.assigned === 'FLORES, MYLES O. TAMO' ? 'selected' : ''}>FLORES, MYLES O. TAMO</option>
                  <option value="QUITLONG, FERDINAND B." ${item.assigned === 'QUITLONG, FERDINAND B.' ? 'selected' : ''}>QUITLONG, FERDINAND B.</option>
                  <option value="VELASQUEZ, VIOLY ANN D." ${item.assigned === 'VELASQUEZ, VIOLY ANN D.' ? 'selected' : ''}>VELASQUEZ, VIOLY ANN D.</option>
                  <option value="VISITACION, JEVERT E." ${item.assigned === 'VISITACION, JEVERT E.' ? 'selected' : ''}>VISITACION, JEVERT E.</option>
                </select>
              </div>
            `;
            
            itemsContainer.appendChild(itemDiv);
          });
          
          itemCounter = requisition.items.length;
        }
        
        openModal(requisitionModal);
      }
    }
    
    // Function to toggle the "Other Purpose" field visibility
    function toggleOtherPurpose() {
      const purposeSelect = document.getElementById('req-purpose');
      const otherPurposeDiv = document.getElementById('other-purpose-div');
      
      if (purposeSelect.value === 'Others') {
        otherPurposeDiv.style.display = 'block';
      } else {
        otherPurposeDiv.style.display = 'none';
      }
    }
    
    // Add new item entry
    let itemCounter = 1;
    document.getElementById('add-item-btn').addEventListener('click', () => {
      const itemsContainer = document.getElementById('items-container');
      
      const newItemDiv = document.createElement('div');
      newItemDiv.className = 'item-entry';
      newItemDiv.innerHTML = `
        <button type="button" class="remove-item-btn" onclick="removeItem(this)">
          <i class="fas fa-times"></i>
        </button>
        <div class="form-group">
          <label for="req-item-name-${itemCounter}">Item Name & Specifications</label>
          <input type="text" class="form-control" id="req-item-name-${itemCounter}">
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="req-item-qty-${itemCounter}">Quantity/Unit</label>
            <input type="text" class="form-control" id="req-item-qty-${itemCounter}">
          </div>
          <div class="form-group">
            <label for="req-item-brand-${itemCounter}">Brand/Model</label>
            <input type="text" class="form-control" id="req-item-brand-${itemCounter}">
          </div>
        </div>
        <div class="form-group">
          <label for="req-item-assigned-${itemCounter}">Assigned To</label>
          <select class="form-control" id="req-item-assigned-${itemCounter}">
            <option value="">Not Assigned</option>
            <option value="CASTILLO, MARK IAN">CASTILLO, MARK IAN</option>
            <option value="EGUID, RUBIE ANN T. PADIERNOS">EGUID, RUBIE ANN T. PADIERNOS</option>
            <option value="FLORES, MYLES O. TAMO">FLORES, MYLES O. TAMO</option>
            <option value="QUITLONG, FERDINAND B.">QUITLONG, FERDINAND B.</option>
            <option value="VELASQUEZ, VIOLY ANN D.">VELASQUEZ, VIOLY ANN D.</option>
            <option value="VISITACION, JEVERT E.">VISITACION, JEVERT E.</option>
          </select>
        </div>
      `;
      
      itemsContainer.appendChild(newItemDiv);
      itemCounter++;
    });
    
    // Function to remove an item entry
    function removeItem(button) {
      button.parentElement.remove();
    }
    
    // Search functionality for requisitions
    document.getElementById('requisition-search').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      filterRequisitions('all-requisitions-table', searchTerm);
    });
    
    document.getElementById('consumable-search').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      filterRequisitions('consumable-table', searchTerm);
    });
    
    document.getElementById('non-consumable-search').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      filterRequisitions('non-consumable-table', searchTerm);
    });
    
    // Search functionality for purchase orders
    document.getElementById('purchase-order-search').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      filterPurchaseOrders('purchase-orders-table', searchTerm);
    });
    
    function filterRequisitions(tableId, searchTerm) {
      const table = document.getElementById(tableId);
      const rows = table.getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const rowText = rows[i].textContent.toLowerCase();
        
        if (rowText.includes(searchTerm)) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
    }
    
    function filterPurchaseOrders(tableId, searchTerm) {
      const table = document.getElementById(tableId);
      const rows = table.getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const rowText = rows[i].textContent.toLowerCase();
        
        if (rowText.includes(searchTerm)) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
    }
    
    // Save Requisition
    saveRequisitionBtn.addEventListener('click', () => {
      const reqId = document.getElementById('req-id').value.trim();
      const office = document.getElementById('req-office').value;
      const type = document.getElementById('req-type').value;
      const quantity = document.getElementById('req-quantity').value;
      const dateReceived = document.getElementById('req-date').value;
      const dateRequested = document.getElementById('req-date-requested').value || new Date().toISOString().split('T')[0];
      const accountableOfficer = document.getElementById('req-officer').value;
      const status = document.getElementById('req-status').value;
      const purpose = document.getElementById('req-purpose').value;
      const otherPurpose = document.getElementById('req-other-purpose').value;
      const finalPurpose = purpose === 'Others' ? otherPurpose : purpose;
      const description = document.getElementById('req-description').value;
      
      if (office && type && quantity && dateReceived && accountableOfficer && status && 
          (purpose !== 'Others' || (purpose === 'Others' && otherPurpose))) {
        let id;
        
        if (editingRequisitionId) {
          // If editing, use the existing ID
          id = editingRequisitionId;
        } else {
          // Use manual ID if provided, otherwise auto-generate
          if (reqId) {
            // Check if the ID already exists
            const existingReq = requisitionData.find(req => req.id === reqId);
            if (existingReq) {
              alert('Requisition number already exists. Please use a different number or leave blank for auto-generation.');
              return;
            }
            id = reqId;
          } else {
            const prefix = type === 'Consumable' ? 'RC' : 'RNC';
            id = `${prefix}2505-${(requisitionData.length + 1).toString().padStart(4, '0')}`;
          }
        }
        
        // Collect all item entries
        const items = [];
        const itemEntries = document.querySelectorAll('.item-entry');
        
        itemEntries.forEach((entry, index) => {
          const nameInput = entry.querySelector(`input[id^="req-item-name"]`);
          const qtyInput = entry.querySelector(`input[id^="req-item-qty"]`);
          const brandInput = entry.querySelector(`input[id^="req-item-brand"]`);
          const assignedSelect = entry.querySelector(`select[id^="req-item-assigned"]`);
          
          if (nameInput && nameInput.value && qtyInput && qtyInput.value) {
            items.push({
              id: index + 1,
              name: nameInput.value,
              quantity: qtyInput.value,
              brand: brandInput ? brandInput.value || '-' : '-',
              assigned: assignedSelect ? assignedSelect.value || '-' : '-',
              otherDetails: 'N/A'
            });
          }
        });
        
        const staffInCharge = document.getElementById('req-staff-in-charge').value;
        
        const newRequisition = {
          id,
          office,
          type,
          dateReceived,
          dateRequested,
          quantity: parseInt(quantity),
          accountableOfficer,
          staffInCharge,
          status,
          purpose: finalPurpose,
          description,
          items
        };
        
        if (editingRequisitionId) {
          // Update existing requisition
          const index = requisitionData.findIndex(req => req.id === editingRequisitionId);
          if (index !== -1) {
            requisitionData[index] = newRequisition;
          }
          editingRequisitionId = null;
        } else {
          // Add new requisition
          requisitionData.push(newRequisition);
        }
        
        // Save to local storage for auto-save functionality
        saveDataToLocalStorage();
        
        populateRequisitionTables();
        populateMonthlyRequisitions();
        updateCharts();
        updateDashboardMetrics();
        
        // Reset form
        document.getElementById('requisitionForm').reset();
        
        // Reset items container to original state
        const itemsContainer = document.getElementById('items-container');
        itemsContainer.innerHTML = `
          <div class="item-entry">
            <div class="form-group">
              <label for="req-item-name-0">Item Name & Specifications</label>
              <input type="text" class="form-control" id="req-item-name-0">
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="req-item-qty-0">Quantity/Unit</label>
                <input type="text" class="form-control" id="req-item-qty-0">
              </div>
              <div class="form-group">
                <label for="req-item-brand-0">Brand/Model</label>
                <input type="text" class="form-control" id="req-item-brand-0">
              </div>
            </div>
            <div class="form-group">
              <label for="req-item-assigned-0">Assigned To</label>
              <select class="form-control" id="req-item-assigned-0">
                <option value="">Not Assigned</option>
                <option value="CASTILLO, MARK IAN">CASTILLO, MARK IAN</option>
                <option value="EGUID, RUBIE ANN T. PADIERNOS">EGUID, RUBIE ANN T. PADIERNOS</option>
                <option value="FLORES, MYLES O. TAMO">FLORES, MYLES O. TAMO</option>
                <option value="QUITLONG, FERDINAND B.">QUITLONG, FERDINAND B.</option>
                <option value="VELASQUEZ, VIOLY ANN D.">VELASQUEZ, VIOLY ANN D.</option>
                <option value="VISITACION, JEVERT E.">VISITACION, JEVERT E.</option>
              </select>
            </div>
          </div>
        `;
        
        // Reset form and close modal
        resetRequisitionForm();
        closeModal(requisitionModal);
      } else {
        alert('Please fill in all required fields. If you selected "Others" for purpose, please specify the purpose.');
      }
    });
    
    // Save Supplier
    saveSupplierBtn.addEventListener('click', () => {
      const company = document.getElementById('supplier-company').value;
      const contact = document.getElementById('supplier-contact').value;
      const email = document.getElementById('supplier-email').value;
      const phone = document.getElementById('supplier-phone').value;
      const tin = document.getElementById('supplier-tin').value;
      const vat = document.getElementById('supplier-vat').value;
      const category = document.getElementById('supplier-category').value;
      const status = document.getElementById('supplier-status').value;
      
      if (company && contact && email && phone && tin && vat && category && status) {
        // Check if we're editing an existing supplier or creating a new one
        if (window.editingSupplierID) {
          // Find the supplier we're editing
          const supplierIndex = supplierData.findIndex(sup => sup.id === window.editingSupplierID);
          
          if (supplierIndex !== -1) {
            // Update the supplier data
            supplierData[supplierIndex] = {
              id: window.editingSupplierID,
              company,
              contact,
              email,
              phone,
              tin,
              vat,
              category,
              status
            };
            
            // Reset the editing ID
            window.editingSupplierID = null;
            
            // Reset modal title
            document.querySelector('#supplierModal .modal-header h2').textContent = 'Add New Supplier';
          }
        } else {
          // Creating a new supplier
          const id = `SUP-${Date.now().toString().substring(6)}`;
          
          const newSupplier = {
            id,
            company,
            contact,
            email,
            phone,
            tin,
            vat,
            category,
            status
          };
          
          supplierData.push(newSupplier);
        }
        
        // Save to local storage for auto-save functionality
        saveDataToLocalStorage();
        
        populateSuppliersTable();
        updateDashboardMetrics();
        
        // Reset form
        document.getElementById('supplierForm').reset();
        closeModal(supplierModal);
      } else {
        alert('Please fill in all required fields');
      }
    });
    
    // Save Purchase Order
    savePurchaseOrderBtn.addEventListener('click', () => {
      // Check which supplier input to use (dropdown or manual)
      const useManualSupplier = document.getElementById('use-manual-supplier').checked;
      const supplierName = useManualSupplier 
        ? document.getElementById('po-manual-supplier').value 
        : document.getElementById('po-supplier').value;
      
      // Gather all requisition IDs
      const useManualRequisition = document.getElementById('use-manual-requisition').checked;
      let requisitionIds = [];
      
      if (useManualRequisition) {
        // Get all manual input values
        document.querySelectorAll('#requisition-selection-container .requisition-entry input[type="text"]').forEach(input => {
          if (input.value.trim()) {
            requisitionIds.push(input.value.trim());
          }
        });
      } else {
        // Get all dropdown values
        document.querySelectorAll('#requisition-selection-container .requisition-entry select').forEach(select => {
          if (select.value) {
            requisitionIds.push(select.value);
          }
        });
      }
      
      // Use first requisition ID as primary (for compatibility with existing code)
      const requisitionId = requisitionIds.length > 0 ? requisitionIds[0] : '';
      
      const poNumber = document.getElementById('po-number').value.trim();
      const dateOrdered = document.getElementById('po-date-ordered').value;
      const status = document.getElementById('po-status').value;
      const dateDelivered = document.getElementById('po-date-delivered').value;
      const notes = document.getElementById('po-notes').value;
      const estimatedDelivery = document.getElementById('po-estimated-delivery').value;
      const procurementMode = document.getElementById('po-procurement-mode').value;
      const receivingOfficer = document.getElementById('po-receiving-officer').value;
      
      // Gather all delivery dates
      const deliveryDates = [];
      document.querySelectorAll('#delivery-dates-container .delivery-date-entry input[type="date"]').forEach(input => {
        if (input.value) {
          deliveryDates.push(input.value);
        }
      });
      
      // Use first date as primary date needed (for compatibility)
      const dateNeeded = deliveryDates.length > 0 ? deliveryDates[0] : '';
      

      
      // Validate required fields
      if (supplierName && dateOrdered && requisitionId && dateNeeded && status) {
        // If using manual supplier/requisition, make sure they're not empty
        if ((document.getElementById('use-manual-supplier').checked && !document.getElementById('po-manual-supplier').value) ||
            (document.getElementById('use-manual-requisition').checked && !document.getElementById('po-manual-requisition').value)) {
          alert('Please fill in all required fields, including manual supplier and requisition if selected.');
          return;
        }
        let id;
        if (window.editingPurchaseOrderId) {
          // If editing, use the existing ID
          id = window.editingPurchaseOrderId;
        } else {
          // Use manual PO number if provided, otherwise auto-generate
          if (poNumber) {
            // Check if the PO number already exists
            const existingPO = purchaseOrderData.find(po => po.poNumber === poNumber);
            if (existingPO) {
              alert('PO number already exists. Please use a different number or leave blank for auto-generation.');
              return;
            }
            id = poNumber;
          } else {
            // Generate PO number with format: PO-YYYYMM-XXXX
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            id = `PO-${year}${month}-${(purchaseOrderData.length + 1).toString().padStart(4, '0')}`;
          }
        }
        
        // Get requisition details for department info
        let department = '';
        if (document.getElementById('use-manual-requisition').checked) {
          // For manual requisition, allow setting department manually
          department = document.getElementById('po-department') ? 
                      document.getElementById('po-department').value : '';
        } else {
          // For dropdown selection, get from requisition data
          const requisition = requisitionData.find(req => req.id === requisitionId);
          department = requisition ? requisition.office : '';
        }
        
        // Calculate audit metrics if dates are available
        let leadTime = null;
        let delay = null;
        let complianceStatus = 'Not Applicable';
        
        if (dateDelivered && dateOrdered) {
          // Calculate lead time in days: actual delivery - order date
          const deliveryDate = new Date(dateDelivered);
          const orderDate = new Date(dateOrdered);
          leadTime = Math.round((deliveryDate - orderDate) / (1000 * 60 * 60 * 24));
        }
        
        if (dateDelivered && dateNeeded) {
          // Calculate delay in days: actual delivery - needed date
          // Negative value means delivered early, positive means delivered late
          const deliveryDate = new Date(dateDelivered);
          const neededDate = new Date(dateNeeded);
          delay = Math.round((deliveryDate - neededDate) / (1000 * 60 * 60 * 24));
          
          // Set compliance status based on delay
          if (delay <= 0) {
            complianceStatus = 'Compliant';
          } else if (delay > 30) { // 30 days threshold
            complianceStatus = 'Non-Compliant';
          } else {
            complianceStatus = 'Within Threshold';
          }
        }
        
        // Default document status since supporting details section was removed
        const documents = {
          pr: "Not Required",
          po: "Not Required",
          deliveryReceipt: "Not Required",
          inspectionReport: "Not Required"
        };
        
        // Since all documents are set to Not Required
        const documentsComplete = true;

        // Create purchase order object
        const purchaseOrder = {
          id: window.editingPurchaseOrderId || id,
          poNumber: poNumber || id,
          supplierName,
          dateOrdered,
          requisitionId,
          requisitionIds, // Store all requisitions
          dateNeeded,
          deliveryDates, // Store all delivery dates
          dateDelivered: dateDelivered || null,
          estimatedDelivery: estimatedDelivery || null,
          procurementMode: procurementMode || 'Direct Purchase',
          receivingOfficer: receivingOfficer || '',
          status,
          notes,
          department,
          
          // Audit fields
          createdAt: window.editingPurchaseOrderId ? undefined : new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          leadTime,
          delay,
          complianceStatus,
          
          // Supporting documents
          documents,
          documentsComplete
        };

        if (window.editingPurchaseOrderId) {
          // Update existing purchase order
          const index = purchaseOrderData.findIndex(po => po.id === window.editingPurchaseOrderId);
          if (index !== -1) {
            // Preserve the createdAt field when updating
            purchaseOrder.createdAt = purchaseOrderData[index].createdAt;
            purchaseOrderData[index] = purchaseOrder;
          }
          window.editingPurchaseOrderId = null;
        } else {
          // Add new purchase order
          purchaseOrderData.push(purchaseOrder);
        }

        // Update the requisition status if needed
        if (status === 'Ordered' || status === 'Delivered') {
          const requisition = requisitionData.find(req => req.id === requisitionId);
          if (requisition && requisition.status === 'Still Processing') {
            requisition.status = status;
          }
        }

        // Save to local storage
        saveDataToLocalStorage();
        
        // Update UI
        populatePurchaseOrdersTable();
        populateRequisitionTables();
        populateDeliveryTracker();
        updateAuditDashboard();
        
        // Reset form and close modal
        document.getElementById('purchaseOrderForm').reset();
        document.querySelector('#purchaseOrderModal .modal-header h2').textContent = 'Create New Purchase Order';
        closeModal(purchaseOrderModal);
      } else {
        alert('Please fill in all required fields.');
      }
      
      if (supplierName && dateOrdered && requisitionId && dateNeeded && status) {
        let id;
        
        // Use manual PO number if provided, otherwise auto-generate
        if (poNumber) {
          // Check if the PO number already exists
          const existingPO = purchaseOrderData.find(po => po.poNumber === poNumber);
          if (existingPO) {
            alert('Purchase Order number already exists. Please use a different number or leave blank for auto-generation.');
            return;
          }
          id = poNumber;
        } else {
          id = `PO-${new Date().getFullYear()}-${(purchaseOrderData.length + 1).toString().padStart(4, '0')}`;
        }
        
        const newPurchaseOrder = {
          id,
          supplierName,
          poNumber: id,
          dateOrdered,
          requisitionId,
          dateNeeded,
          dateDelivered: dateDelivered || null,
          status,
          notes
        };
        
        purchaseOrderData.push(newPurchaseOrder);
        
        // Save to local storage for auto-save functionality
        saveDataToLocalStorage();
        
        populatePurchaseOrdersTable();
        
        // Reset form
        document.getElementById('purchaseOrderForm').reset();
        closeModal(purchaseOrderModal);
      } else {
        alert('Please fill in all required fields');
      }
    });
    
    // Populate Requisition Tables
    function populateRequisitionTables() {
      // Check user permissions
      const userPermissions = userRoles[currentUserRole].permissions;
      const canEdit = userPermissions.includes('edit');
      const canDelete = userPermissions.includes('delete');
      
      // Recent Requisitions (Dashboard)
      const recentRequisitionsTable = document.getElementById('recent-requisitions');
      recentRequisitionsTable.innerHTML = '';
      
      // Sort by date (newest first)
      const sortedRequisitions = [...requisitionData].sort((a, b) => new Date(b.dateReceived) - new Date(a.dateReceived));
      
      // Display only the 5 most recent
      const recentRequisitions = sortedRequisitions.slice(0, 5);
      
      recentRequisitions.forEach(req => {
        const row = document.createElement('tr');
        
        let actionButtons = '';
        
        // Create view button for all roles
        actionButtons = `<button class="btn btn-secondary btn-sm view-req" data-id="${req.id}" title="View Details"><i class="fas fa-eye"></i></button> `;
        
        // Status-based action buttons - only if user has permissions
        if (canEdit) {
          if (req.status === 'Still Processing') {
            actionButtons += `
              <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
              <button class="btn btn-secondary btn-sm status-change" data-id="${req.id}" data-status="Ordered">Move to Ordered</button>
              <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            `;
          } else if (req.status === 'Ordered') {
            actionButtons += `
              <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
              <button class="btn btn-success btn-sm status-change" data-id="${req.id}" data-status="Delivered">Mark as Delivered</button>
              <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            `;
          } else {
            actionButtons += `
              <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            `;
          }
        }
        
        // Delete button - only if user has delete permission
        if (canDelete) {
          actionButtons += `<button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>`;
        }
        
        row.innerHTML = `
          <td><span class="req-number-link" data-id="${req.id}">${req.id}</span></td>
          <td>${req.office}</td>
          <td>${req.type}</td>
          <td>${formatDate(req.dateReceived)}</td>
          <td>${req.purpose}</td>
          <td>${req.accountableOfficer}</td>
          <td>${req.staffInCharge || '-'}</td>
          <td>
            <span class="badge badge-${getBadgeClass(req.status)}">${req.status}</span>
          </td>
          <td>
            ${actionButtons}
          </td>
        `;
        
        recentRequisitionsTable.appendChild(row);
      });
      
      // All Requisitions
      const allRequisitionsTable = document.getElementById('all-requisitions-table');
      allRequisitionsTable.innerHTML = '';
      
      sortedRequisitions.forEach(req => {
        const row = document.createElement('tr');
        
        let actionButtons = '';
        
        // Create view button for all roles
        actionButtons = `<button class="btn btn-secondary btn-sm view-req" data-id="${req.id}" title="View Details"><i class="fas fa-eye"></i></button> `;
        
        // Status-based action buttons - only if user has permissions
        if (canEdit) {
          if (req.status === 'Still Processing') {
            actionButtons += `
              <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
              <button class="btn btn-secondary btn-sm status-change" data-id="${req.id}" data-status="Ordered">Move to Ordered</button>
              <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            `;
          } else if (req.status === 'Ordered') {
            actionButtons += `
              <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
              <button class="btn btn-success btn-sm status-change" data-id="${req.id}" data-status="Delivered">Mark as Delivered</button>
              <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            `;
          } else {
            actionButtons += `
              <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            `;
          }
        }
        
        // Delete button - only if user has delete permission
        if (canDelete) {
          actionButtons += `<button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>`;
        }
        
        row.innerHTML = `
          <td><span class="req-number-link" data-id="${req.id}">${req.id}</span></td>
          <td>${req.office}</td>
          <td>${req.type}</td>
          <td>${formatDate(req.dateReceived)}</td>
          <td>${req.purpose}</td>
          <td>${req.accountableOfficer}</td>
          <td>
            <span class="badge badge-${getBadgeClass(req.status)}">${req.status}</span>
          </td>
          <td>
            ${actionButtons}
          </td>
        `;
        
        allRequisitionsTable.appendChild(row);
      });
      
      // Consumable Requisitions
      const consumableTable = document.getElementById('consumable-table');
      consumableTable.innerHTML = '';
      
      const consumableRequisitions = sortedRequisitions.filter(req => req.type === 'Consumable');
      
      consumableRequisitions.forEach(req => {
        const row = document.createElement('tr');
        
        let actionButtons = '';
        
        // Status-based action buttons
        if (req.status === 'Still Processing') {
          actionButtons = `
            <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            <button class="btn btn-secondary btn-sm status-change" data-id="${req.id}" data-status="Ordered">Move to Ordered</button>
            <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            <button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>
          `;
        } else if (req.status === 'Ordered') {
          actionButtons = `
            <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            <button class="btn btn-success btn-sm status-change" data-id="${req.id}" data-status="Delivered">Mark as Delivered</button>
            <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            <button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>
          `;
        } else {
          actionButtons = `
            <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            <button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>
          `;
        }
        
        row.innerHTML = `
          <td><span class="req-number-link" data-id="${req.id}">${req.id}</span></td>
          <td>${req.office}</td>
          <td>${formatDate(req.dateReceived)}</td>
          <td>${req.purpose}</td>
          <td>${req.accountableOfficer}</td>
          <td>
            <span class="badge badge-${getBadgeClass(req.status)}">${req.status}</span>
          </td>
          <td>
            ${actionButtons}
          </td>
        `;
        
        consumableTable.appendChild(row);
      });
      
      // Non-Consumable Requisitions
      const nonConsumableTable = document.getElementById('non-consumable-table');
      nonConsumableTable.innerHTML = '';
      
      const nonConsumableRequisitions = sortedRequisitions.filter(req => req.type === 'Non-Consumable');
      
      nonConsumableRequisitions.forEach(req => {
        const row = document.createElement('tr');
        
        let actionButtons = '';
        
        // Status-based action buttons
        if (req.status === 'Still Processing') {
          actionButtons = `
            <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            <button class="btn btn-secondary btn-sm status-change" data-id="${req.id}" data-status="Ordered">Move to Ordered</button>
            <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            <button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>
          `;
        } else if (req.status === 'Ordered') {
          actionButtons = `
            <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            <button class="btn btn-success btn-sm status-change" data-id="${req.id}" data-status="Delivered">Mark as Delivered</button>
            <button class="btn btn-warning btn-sm status-change" data-id="${req.id}" data-status="Cancelled">Mark as Cancelled</button>
            <button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>
          `;
        } else {
          actionButtons = `
            <button class="btn btn-info btn-sm edit-req" data-id="${req.id}" title="Edit"><i class="fas fa-pen"></i></button>
            <button class="btn btn-danger btn-sm delete-req" data-id="${req.id}">Delete</button>
          `;
        }
        
        row.innerHTML = `
          <td><span class="req-number-link" data-id="${req.id}">${req.id}</span></td>
          <td>${req.office}</td>
          <td>${formatDate(req.dateReceived)}</td>
          <td>${req.purpose}</td>
          <td>${req.accountableOfficer}</td>
          <td>
            <span class="badge badge-${getBadgeClass(req.status)}">${req.status}</span>
          </td>
          <td>
            ${actionButtons}
          </td>
        `;
        
        nonConsumableTable.appendChild(row);
      });
      
      // Add event listeners for requisition number links
      document.querySelectorAll('.req-number-link').forEach(link => {
        link.addEventListener('click', () => {
          const id = link.getAttribute('data-id');
          viewRequisitionDetails(id);
        });
      });
    }
    
    // Update Dashboard Metrics
    function updateDashboardMetrics() {
      const totalRequisitions = requisitionData.length;
      const pendingRequisitions = requisitionData.filter(req => req.status === 'Still Processing' || req.status === 'Ordered').length;
      const deliveredRequisitions = requisitionData.filter(req => req.status === 'Delivered').length;
      const cancelledRequisitions = requisitionData.filter(req => req.status === 'Cancelled').length;
      const activeSuppliers = supplierData.filter(sup => sup.status === 'Active').length;
      
      document.getElementById('total-requisitions').textContent = totalRequisitions;
      document.getElementById('pending-requisitions').textContent = pendingRequisitions;
      document.getElementById('delivered-requisitions').textContent = deliveredRequisitions;
      document.getElementById('active-suppliers').textContent = activeSuppliers;
    }
    
    // Populate Purchase Orders Table
    function populatePurchaseOrdersTable() {
      const purchaseOrdersTable = document.getElementById('purchase-orders-table');
      purchaseOrdersTable.innerHTML = '';
      
      // Sort by date (newest first)
      const sortedPOs = [...purchaseOrderData].sort((a, b) => new Date(b.dateOrdered) - new Date(a.dateOrdered));
      
      sortedPOs.forEach(po => {
        const row = document.createElement('tr');
        
        let statusBadge = '';
        switch (po.status) {
          case 'Pending':
            statusBadge = 'badge-processing';
            break;
          case 'Ordered':
            statusBadge = 'badge-ordered';
            break;
          case 'Partially Delivered':
            statusBadge = 'badge-warning';
            break;
          case 'Delivered':
            statusBadge = 'badge-delivered';
            break;
          case 'Cancelled':
            statusBadge = 'badge-danger';
            break;
          default:
            statusBadge = 'badge-processing';
        }
        
        // Add efficiency indicators for delivered items
        let efficiencyIndicator = '';
        if (po.status === 'Delivered' && po.delay !== null) {
          if (po.delay <= 0) {
            // On time or early
            efficiencyIndicator = '<i class="fas fa-check-circle" style="color: green; margin-left: 5px;" title="Delivered on time"></i>';
          } else if (po.delay > 0 && po.delay <= 7) {
            // Slightly delayed (within a week)
            efficiencyIndicator = '<i class="fas fa-exclamation-circle" style="color: orange; margin-left: 5px;" title="Slight delay"></i>';
          } else {
            // Significantly delayed
            efficiencyIndicator = '<i class="fas fa-times-circle" style="color: red; margin-left: 5px;" title="Significant delay"></i>';
          }
        }
        
        let actionButtons = `
          <button class="btn btn-info btn-sm edit-po" data-id="${po.id}" title="Edit"><i class="fas fa-pen"></i></button>
          <button class="btn btn-danger btn-sm delete-po" data-id="${po.id}" title="Delete"><i class="fas fa-trash"></i></button>
        `;
        
        if (po.status !== 'Delivered' && po.status !== 'Cancelled') {
          actionButtons += `
            <button class="btn btn-success btn-sm mark-delivered" data-id="${po.id}" title="Mark as Delivered"><i class="fas fa-check"></i></button>
          `;
        }
        
        // Add audit button
        actionButtons += `
          <button class="btn btn-secondary btn-sm view-audit" data-id="${po.id}" title="View Audit Details"><i class="fas fa-clipboard-list"></i></button>
        `;
        
        row.innerHTML = `
          <td>${po.supplierName}</td>
          <td>${po.poNumber}</td>
          <td>${formatDate(po.dateOrdered)}</td>
          <td>${po.requisitionId}</td>
          <td>${po.dateDelivered ? formatDate(po.dateDelivered) : '-'}</td>
          <td>${formatDate(po.dateNeeded)}</td>
          <td><span class="badge ${statusBadge}">${po.status}${efficiencyIndicator}</span></td>
          <td>${actionButtons}</td>
        `;
        
        purchaseOrdersTable.appendChild(row);
      });
      
      // Add event listeners for purchase order actions
      document.querySelectorAll('.edit-po').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          editPurchaseOrder(id);
        });
      });
      
      document.querySelectorAll('.delete-po').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this purchase order?')) {
            deletePurchaseOrder(id);
          }
        });
      });
      
      document.querySelectorAll('.mark-delivered').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          markPurchaseOrderAsDelivered(id);
        });
      });
      
      document.querySelectorAll('.view-audit').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          viewAuditDetails(id);
        });
      });
    }
    
    // View Audit Details
    function viewAuditDetails(id) {
      const po = purchaseOrderData.find(order => order.id === id);
      
      if (po) {
        let message = `
          <h3>Audit Information for PO #${po.poNumber}</h3>
          <table class="details-table" style="width: 100%;">
            <tr>
              <td><strong>Supplier:</strong></td>
              <td>${po.supplierName}</td>
            </tr>
            <tr>
              <td><strong>Requisition #:</strong></td>
              <td>${po.requisitionId}</td>
            </tr>
            <tr>
              <td><strong>Department:</strong></td>
              <td>${po.department || 'Not specified'}</td>
            </tr>
            <tr>
              <td><strong>Date Ordered:</strong></td>
              <td>${formatDate(po.dateOrdered)}</td>
            </tr>
            <tr>
              <td><strong>Date Needed:</strong></td>
              <td>${formatDate(po.dateNeeded)}</td>
            </tr>
            <tr>
              <td><strong>Estimated Delivery:</strong></td>
              <td>${po.estimatedDelivery ? formatDate(po.estimatedDelivery) : 'Not specified'}</td>
            </tr>
            <tr>
              <td><strong>Actual Delivery:</strong></td>
              <td>${po.dateDelivered ? formatDate(po.dateDelivered) : 'Not yet delivered'}</td>
            </tr>
            <tr>
              <td><strong>Status:</strong></td>
              <td>${po.status}</td>
            </tr>
            <tr>
              <td><strong>Procurement Mode:</strong></td>
              <td>${po.procurementMode || 'Not specified'}</td>
            </tr>
            <tr>
              <td><strong>Receiving Officer:</strong></td>
              <td>${po.receivingOfficer || 'Not specified'}</td>
            </tr>
          </table>
          
          <h4 style="margin-top: 20px;">Timeline Performance</h4>
          <table class="details-table" style="width: 100%;">
            <tr>
              <td><strong>Lead Time:</strong></td>
              <td>${po.leadTime !== null ? po.leadTime + ' days' : 'Not applicable'}</td>
            </tr>
            <tr>
              <td><strong>Delivery Variance:</strong></td>
              <td>${po.delay !== null ? (po.delay > 0 ? '+' + po.delay + ' days (late)' : po.delay + ' days (early)') : 'Not applicable'}</td>
            </tr>
            <tr>
              <td><strong>Compliance Status:</strong></td>
              <td>${po.complianceStatus || 'Not applicable'}</td>
            </tr>
          </table>
          
          <h4 style="margin-top: 20px;">Documents Status</h4>
          <table class="details-table" style="width: 100%;">
        `;
        
        if (po.documents) {
          message += `
            <tr>
              <td><strong>PR Document:</strong></td>
              <td>${po.documents.pr || 'Not Required'}</td>
            </tr>
            <tr>
              <td><strong>PO Document:</strong></td>
              <td>${po.documents.po || 'Not Required'}</td>
            </tr>
            <tr>
              <td><strong>Delivery Receipt:</strong></td>
              <td>${po.documents.deliveryReceipt || 'Not Required'}</td>
            </tr>
            <tr>
              <td><strong>Inspection Report:</strong></td>
              <td>${po.documents.inspectionReport || 'Not Required'}</td>
            </tr>
            <tr>
              <td><strong>All Documents Complete:</strong></td>
              <td>${po.documentsComplete ? 'Yes' : 'No'}</td>
            </tr>
          `;
        } else {
          message += `<tr><td colspan="2">No document information available</td></tr>`;
        }
        
        message += `
          </table>
          
          <h4 style="margin-top: 20px;">Audit Timeline</h4>
          <table class="details-table" style="width: 100%;">
            <tr>
              <td><strong>Created At:</strong></td>
              <td>${po.createdAt ? new Date(po.createdAt).toLocaleString() : 'Not available'}</td>
            </tr>
            <tr>
              <td><strong>Last Updated:</strong></td>
              <td>${po.updatedAt ? new Date(po.updatedAt).toLocaleString() : 'Not available'}</td>
            </tr>
          </table>
        `;
        
        alert(message);
      }
    }
    
    // Populate Supplier Dropdown
    function populateSupplierDropdown() {
      const supplierSelect = document.getElementById('po-supplier');
      const manualSupplierInput = document.getElementById('po-manual-supplier');
      const useManualSupplierCheckbox = document.getElementById('use-manual-supplier');
      
      // Hide or show appropriate input based on checkbox state
      if (useManualSupplierCheckbox && useManualSupplierCheckbox.checked) {
        // Show manual input, hide dropdown
        if (supplierSelect) supplierSelect.style.display = 'none';
        if (manualSupplierInput) manualSupplierInput.style.display = 'block';
      } else {
        // Show dropdown, hide manual input
        if (supplierSelect) supplierSelect.style.display = 'block';
        if (manualSupplierInput) manualSupplierInput.style.display = 'none';
        
        // Populate the dropdown with suppliers from Excel data
        supplierSelect.innerHTML = '<option value="">Select Supplier</option>';
        
        suppliersData.forEach(supplier => {
          const option = document.createElement('option');
          option.value = supplier.supplierName;
          option.textContent = supplier.supplierName;
          option.dataset.products = supplier.productsServices;
          option.dataset.contact = supplier.contactPerson;
          option.dataset.phone = supplier.contactNumber;
          option.dataset.email = supplier.emailAddress;
          supplierSelect.appendChild(option);
        });
      }
      
      // Also populate audit filter dropdown if it exists
      const auditSupplierFilter = document.getElementById('audit-filter-supplier');
      if (auditSupplierFilter) {
        auditSupplierFilter.innerHTML = '<option value="all">All Suppliers</option>';
        
        supplierData.forEach(supplier => {
          const option = document.createElement('option');
          option.value = supplier.company;
          option.textContent = supplier.company;
          auditSupplierFilter.appendChild(option);
        });
      }
    }
    
    // Populate Requisition Dropdown
    function populateRequisitionDropdown() {
      const requisitionSelect = document.getElementById('po-requisition');
      
      // Populate the dropdown
      requisitionSelect.innerHTML = '<option value="">Select Requisition</option>';
      
      requisitionData.forEach(req => {
        if (req.status !== 'Cancelled') {
          const option = document.createElement('option');
          option.value = req.id;
          option.textContent = `${req.id} - ${req.office}`;
          requisitionSelect.appendChild(option);
        }
      });
    }
    
    // Toggle between manual and dropdown requisition
    function toggleManualRequisition() {
      const useManualRequisitionCheckbox = document.getElementById('use-manual-requisition');
      const departmentInput = document.getElementById('department-manual-input');
      const isManual = useManualRequisitionCheckbox && useManualRequisitionCheckbox.checked;
      
      // Get all requisition entries
      const entries = document.querySelectorAll('.requisition-entry');
      
      entries.forEach(entry => {
        const select = entry.querySelector('select');
        const input = entry.querySelector('input[type="text"]');
        
        if (isManual) {
          // Show manual input, hide dropdown, show department input
          if (select) select.style.display = 'none';
          if (input) input.style.display = 'block';
          if (departmentInput) departmentInput.style.display = 'block';
        } else {
          // Show dropdown, hide manual input, hide department input
          if (select) select.style.display = 'block';
          if (input) input.style.display = 'none';
          if (departmentInput) departmentInput.style.display = 'none';
        }
      });
      
      // Make sure dropdowns are populated if not using manual
      if (!isManual) {
        populateRequisitionDropdown();
      }
    }
    
    // Add another requisition entry
    document.addEventListener('DOMContentLoaded', function() {
      const addRequisitionBtn = document.getElementById('add-requisition-btn');
      if (addRequisitionBtn) {
        addRequisitionBtn.addEventListener('click', function() {
          const requisitionContainer = document.getElementById('requisition-selection-container');
          const entryCount = requisitionContainer.querySelectorAll('.requisition-entry').length;
          
          const newEntry = document.createElement('div');
          newEntry.className = 'requisition-entry';
          newEntry.style.marginTop = '10px';
          
          const useManualRequisitionCheckbox = document.getElementById('use-manual-requisition');
          const isManual = useManualRequisitionCheckbox && useManualRequisitionCheckbox.checked;
          
          if (isManual) {
            newEntry.innerHTML = `
              <div style="display: flex; align-items: center;">
                <input type="text" class="form-control" placeholder="Enter requisition ID" style="flex: 1;">
                <button type="button" class="btn btn-danger btn-sm remove-requisition-btn" style="margin-left: 10px;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;
          } else {
            newEntry.innerHTML = `
              <div style="display: flex; align-items: center;">
                <select class="form-control" style="flex: 1;">
                  <option value="">Select Requisition</option>
                  <!-- Will be populated by populateRequisitionDropdown -->
                </select>
                <button type="button" class="btn btn-danger btn-sm remove-requisition-btn" style="margin-left: 10px;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;
          }
          
          requisitionContainer.appendChild(newEntry);
          
          // Add event listener for remove button
          newEntry.querySelector('.remove-requisition-btn').addEventListener('click', function() {
            newEntry.remove();
          });
          
          // Populate the new dropdown if not in manual mode
          if (!isManual) {
            const select = newEntry.querySelector('select');
            requisitionData.forEach(req => {
              if (req.status !== 'Cancelled') {
                const option = document.createElement('option');
                option.value = req.id;
                option.textContent = `${req.id} - ${req.office}`;
                select.appendChild(option);
              }
            });
          }
        });
      }
      
      // Add another delivery date
      const addDeliveryDateBtn = document.getElementById('add-delivery-date-btn');
      if (addDeliveryDateBtn) {
        addDeliveryDateBtn.addEventListener('click', function() {
          const datesContainer = document.getElementById('delivery-dates-container');
          
          const newEntry = document.createElement('div');
          newEntry.className = 'delivery-date-entry';
          newEntry.style.marginTop = '10px';
          newEntry.innerHTML = `
            <div style="display: flex; align-items: center;">
              <input type="date" class="form-control" style="flex: 1;">
              <button type="button" class="btn btn-danger btn-sm remove-date-btn" style="margin-left: 10px;">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          datesContainer.appendChild(newEntry);
          
          // Add event listener for remove button
          newEntry.querySelector('.remove-date-btn').addEventListener('click', function() {
            newEntry.remove();
          });
        });
      }
    });
    
    // Edit Purchase Order
    function editPurchaseOrder(id) {
      const po = purchaseOrderData.find(order => order.id === id);
      
      if (po) {
        // Fill form with PO data
        document.getElementById('po-supplier').value = po.supplierName;
        document.getElementById('po-number').value = po.poNumber;
        document.getElementById('po-date-ordered').value = po.dateOrdered;
        document.getElementById('po-requisition').value = po.requisitionId;
        document.getElementById('po-date-needed').value = po.dateNeeded;
        document.getElementById('po-status').value = po.status;
        document.getElementById('po-date-delivered').value = po.dateDelivered || '';
        document.getElementById('po-notes').value = po.notes || '';
        document.getElementById('po-estimated-delivery').value = po.estimatedDelivery || '';
        document.getElementById('po-procurement-mode').value = po.procurementMode || 'Direct Purchase';
        document.getElementById('po-receiving-officer').value = po.receivingOfficer || '';
        
        // Fill supporting documents status
        if (po.documents) {
          document.getElementById('po-pr-doc').value = po.documents.pr || 'Not Required';
          document.getElementById('po-po-doc').value = po.documents.po || 'Not Required';
          document.getElementById('po-delivery-receipt-doc').value = po.documents.deliveryReceipt || 'Not Required';
          document.getElementById('po-inspection-report-doc').value = po.documents.inspectionReport || 'Not Required';
        }
        
        // Update modal title
        document.querySelector('#purchaseOrderModal .modal-header h2').textContent = 'Edit Purchase Order';
        
        // Store editing ID for save function
        window.editingPurchaseOrderId = id;
        
        // Populate dropdowns
        populateSupplierDropdown();
        populateRequisitionDropdown();
        populateReceivingOfficerDropdown();
        
        openModal(purchaseOrderModal);
      }
    }
    
    // Populate Receiving Officer Dropdown
    function populateReceivingOfficerDropdown() {
      const receivingOfficerSelect = document.getElementById('po-receiving-officer');
      receivingOfficerSelect.innerHTML = '<option value="">Select Receiving Officer</option>';
      
      staffData.forEach(staff => {
        const option = document.createElement('option');
        option.value = staff.name;
        option.textContent = staff.name;
        receivingOfficerSelect.appendChild(option);
      });
    }
    
    // Delete Purchase Order
    function deletePurchaseOrder(id) {
      const index = purchaseOrderData.findIndex(po => po.id === id);
      if (index !== -1) {
        purchaseOrderData.splice(index, 1);
        saveDataToLocalStorage();
        populatePurchaseOrdersTable();
      }
    }
    
    // Mark Purchase Order as Delivered
    function markPurchaseOrderAsDelivered(id) {
      const po = purchaseOrderData.find(order => order.id === id);
      if (po) {
        const today = new Date().toISOString().split('T')[0];
        po.status = 'Delivered';
        po.dateDelivered = today;
        po.updatedAt = new Date().toISOString();
        
        // Calculate audit metrics
        if (po.dateOrdered) {
          // Calculate lead time: delivery date - order date
          const deliveryDate = new Date(today);
          const orderDate = new Date(po.dateOrdered);
          po.leadTime = Math.round((deliveryDate - orderDate) / (1000 * 60 * 60 * 24));
        }
        
        if (po.dateNeeded) {
          // Calculate delay: delivery date - needed date
          const deliveryDate = new Date(today);
          const neededDate = new Date(po.dateNeeded);
          po.delay = Math.round((deliveryDate - neededDate) / (1000 * 60 * 60 * 24));
          
          // Set compliance status
          if (po.delay <= 0) {
            po.complianceStatus = 'Compliant';
          } else if (po.delay > 30) { // 30 days threshold
            po.complianceStatus = 'Non-Compliant';
          } else {
            po.complianceStatus = 'Within Threshold';
          }
        }
        
        // Update the requisition status
        const requisition = requisitionData.find(req => req.id === po.requisitionId);
        if (requisition) {
          requisition.status = 'Delivered';
        }
        
        saveDataToLocalStorage();
        populatePurchaseOrdersTable();
        populateDeliveryTracker();
        updateAuditDashboard();
        populateRequisitionTables();
      }
    }
    
    // Populate Suppliers Table
    function populateSuppliersTable() {
      const suppliersTable = document.getElementById('suppliers-table');
      suppliersTable.innerHTML = '';
      
      supplierData.forEach(supplier => {
        const row = document.createElement('tr');
        
        // Generate unique ID if not present
        if (!supplier.id) {
          supplier.id = 'SUP-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }
        
        row.innerHTML = `
          <td>${supplier.company}</td>
          <td>${supplier.contact}</td>
          <td>${supplier.email}</td>
          <td>${supplier.phone}</td>
          <td>${supplier.tin}</td>
          <td>${supplier.vat}</td>
          <td>${supplier.category}</td>
          <td>${supplier.status}</td>
          <td>
            <button class="btn btn-info btn-sm edit-supplier" data-id="${supplier.id}">Edit</button>
            <button class="btn btn-danger btn-sm delete-supplier" data-id="${supplier.id}">Delete</button>
          </td>
        `;
        
        suppliersTable.appendChild(row);
      });
    }
    
    // Populate Staff Table
    function populateStaffTable() {
      const staffTable = document.getElementById('staff-table');
      staffTable.innerHTML = '';
      
      staffData.forEach(staff => {
        // Generate unique ID if not present
        if (!staff.id) {
          staff.id = 'STAFF-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }
        
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${staff.name}</td>
          <td>${staff.position}</td>
          <td>${staff.department}</td>
          <td>${staff.email}</td>
          <td>${staff.phone}</td>
          <td>
            <button class="btn btn-info btn-sm edit-staff" data-id="${staff.id}">Edit</button>
            <button class="btn btn-danger btn-sm delete-staff" data-id="${staff.id}">Delete</button>
          </td>
        `;
        
        staffTable.appendChild(row);
      });
    }
    
    // Edit Staff
    function editStaff(id) {
      const staff = staffData.find(s => s.id === id);
      
      if (staff) {
        // Create a modal for editing if not exists already
        let staffEditModal = document.getElementById('staffEditModal');
        if (!staffEditModal) {
          // Create a new modal for staff editing
          staffEditModal = document.createElement('div');
          staffEditModal.id = 'staffEditModal';
          staffEditModal.className = 'modal';
          staffEditModal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h2>Edit Staff</h2>
                <button class="modal-close">&times;</button>
              </div>
              <div class="modal-body">
                <form id="staffEditForm">
                  <div class="form-grid">
                    <div class="form-group">
                      <label for="staff-name">Name</label>
                      <input type="text" class="form-control" id="staff-name" required>
                    </div>
                    <div class="form-group">
                      <label for="staff-position">Position</label>
                      <input type="text" class="form-control" id="staff-position" required>
                    </div>
                    <div class="form-group">
                      <label for="staff-department">Department</label>
                      <input type="text" class="form-control" id="staff-department" required>
                    </div>
                    <div class="form-group">
                      <label for="staff-email">Email</label>
                      <input type="email" class="form-control" id="staff-email" required>
                    </div>
                    <div class="form-group">
                      <label for="staff-phone">Phone</label>
                      <input type="text" class="form-control" id="staff-phone" required>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button class="btn btn-primary" id="saveStaffBtn">Save</button>
                <button class="btn" id="cancelStaffBtn">Cancel</button>
              </div>
            </div>
          `;
          document.body.appendChild(staffEditModal);
          
          // Add event listeners
          const closeBtn = staffEditModal.querySelector('.modal-close');
          const cancelBtn = staffEditModal.querySelector('#cancelStaffBtn');
          const saveBtn = staffEditModal.querySelector('#saveStaffBtn');
          
          closeBtn.addEventListener('click', () => closeModal(staffEditModal));
          cancelBtn.addEventListener('click', () => closeModal(staffEditModal));
          
          saveBtn.addEventListener('click', () => {
            const name = document.getElementById('staff-name').value;
            const position = document.getElementById('staff-position').value;
            const department = document.getElementById('staff-department').value;
            const email = document.getElementById('staff-email').value;
            const phone = document.getElementById('staff-phone').value;
            
            if (name && position && department && email && phone) {
              const staffIndex = staffData.findIndex(s => s.id === window.editingStaffId);
              
              if (staffIndex !== -1) {
                // Update the staff data
                staffData[staffIndex] = {
                  id: window.editingStaffId,
                  name,
                  position,
                  department,
                  email,
                  phone
                };
                
                // Reset the editing ID
                window.editingStaffId = null;
                
                // Save to local storage
                saveDataToLocalStorage();
                
                // Update the table
                populateStaffTable();
                
                // Close modal
                closeModal(staffEditModal);
              }
            } else {
              alert('Please fill in all required fields');
            }
          });
        }
        
        // Fill form with staff data
        document.getElementById('staff-name').value = staff.name;
        document.getElementById('staff-position').value = staff.position;
        document.getElementById('staff-department').value = staff.department;
        document.getElementById('staff-email').value = staff.email;
        document.getElementById('staff-phone').value = staff.phone;
        
        // Store editing ID for save function
        window.editingStaffId = id;
        
        // Open the modal
        openModal(staffEditModal);
      }
    }
    
    // Delete Staff
    function deleteStaff(id) {
      const index = staffData.findIndex(staff => staff.id === id);
      
      if (index !== -1) {
        staffData.splice(index, 1);
        
        // Save to local storage for auto-save functionality
        saveDataToLocalStorage();
        
        populateStaffTable();
      }
    }
    
    // Initialize tables on page load
    function initializeTables() {
      populateRequisitionTables();
      populateSuppliersTable();
      populateStaffTable();
      populatePurchaseOrdersTable();
      updateDashboardMetrics();
    }
    
    // Save data to localStorage
    function saveDataToLocalStorage() {
      localStorage.setItem('ubProcurementRequisitions', JSON.stringify(requisitionData));
      localStorage.setItem('ubProcurementSuppliers', JSON.stringify(supplierData));
      localStorage.setItem('ubProcurementStaff', JSON.stringify(staffData));
      localStorage.setItem('ubProcurementPurchaseOrders', JSON.stringify(purchaseOrderData));
    }
    
    // Load data from localStorage
    function loadDataFromLocalStorage() {
      const savedRequisitions = localStorage.getItem('ubProcurementRequisitions');
      const savedSuppliers = localStorage.getItem('ubProcurementSuppliers');
      const savedStaff = localStorage.getItem('ubProcurementStaff');
      const savedPurchaseOrders = localStorage.getItem('ubProcurementPurchaseOrders');
      
      if (savedRequisitions) {
        requisitionData.push(...JSON.parse(savedRequisitions));
      }
      
      if (savedSuppliers) {
        supplierData.push(...JSON.parse(savedSuppliers));
      }
      
      if (savedStaff) {
        staffData.push(...JSON.parse(savedStaff));
      }
      
      if (savedPurchaseOrders) {
        purchaseOrderData.push(...JSON.parse(savedPurchaseOrders));
      }
    }
    
    // Populate Delivery Performance Tracker
    function populateDeliveryTracker() {
      const deliveryTrackerTable = document.getElementById('delivery-tracker-table');
      if (!deliveryTrackerTable) return;
      
      deliveryTrackerTable.innerHTML = '';
      
      // Apply filter
      const filterValue = document.getElementById('delivery-filter').value;
      let filteredPOs = [...purchaseOrderData];
      
      switch(filterValue) {
        case 'delivered':
          filteredPOs = filteredPOs.filter(po => po.status === 'Delivered');
          break;
        case 'pending':
          filteredPOs = filteredPOs.filter(po => po.status === 'Pending' || po.status === 'Ordered');
          break;
        case 'delayed':
          filteredPOs = filteredPOs.filter(po => po.delay && po.delay > 0);
          break;
      }
      
      // Sort by date ordered (newest first)
      filteredPOs.sort((a, b) => new Date(b.dateOrdered) - new Date(a.dateOrdered));
      
      filteredPOs.forEach(po => {
        const row = document.createElement('tr');
        
        // Determine status badge class based on delivery performance
        let statusBadge = '';
        let statusText = '';
        
        if (po.status === 'Delivered') {
          if (po.delay <= 0) {
            // On-time delivery
            statusBadge = 'badge-delivered';
            statusText = 'On Time';
          } else if (po.delay > 0 && new Date(po.dateDelivered) <= new Date(po.dateNeeded)) {
            // Delivered late but before date needed
            statusBadge = 'badge-ordered';
            statusText = 'Delivered Late';
          } else {
            // Delivered past date needed
            statusBadge = 'badge-danger';
            statusText = 'Delayed';
          }
        } else if (po.status === 'Pending' || po.status === 'Ordered') {
          if (new Date() > new Date(po.dateNeeded)) {
            // Past due date
            statusBadge = 'badge-danger';
            statusText = 'Past Due';
          } else {
            // Still within timeline
            statusBadge = 'badge-processing';
            statusText = 'In Process';
          }
        } else {
          // Cancelled or other status
          statusBadge = 'badge-danger';
          statusText = po.status;
        }
        
        row.innerHTML = `
          <td>${po.poNumber}</td>
          <td>${po.supplierName}</td>
          <td>${formatDate(po.dateOrdered)}</td>
          <td>${formatDate(po.dateNeeded)}</td>
          <td>${po.estimatedDelivery ? formatDate(po.estimatedDelivery) : '-'}</td>
          <td>${po.dateDelivered ? formatDate(po.dateDelivered) : '-'}</td>
          <td>${po.leadTime !== null ? po.leadTime + ' days' : '-'}</td>
          <td>${po.delay !== null ? (po.delay > 0 ? '+' + po.delay + ' days' : po.delay + ' days') : '-'}</td>
          <td><span class="badge ${statusBadge}">${statusText}</span></td>
        `;
        
        deliveryTrackerTable.appendChild(row);
      });
      
      // If no records match the filter
      if (filteredPOs.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="9" style="text-align: center;">No records found matching the selected filter</td>';
        deliveryTrackerTable.appendChild(row);
      }
    }
    
    // Update Audit Dashboard
    function updateAuditDashboard() {
      // Skip if audit dashboard elements don't exist
      if (!document.getElementById('ontime-percentage')) return;
      
      // Get filter values
      const deptFilter = document.getElementById('audit-filter-dept').value;
      const supplierFilter = document.getElementById('audit-filter-supplier').value;
      const dateFilter = document.getElementById('audit-filter-date').value;
      const complianceFilter = document.getElementById('audit-filter-compliance').value;
      
      // Apply filters to purchase order data
      let filteredPOs = [...purchaseOrderData];
      
      // Department filter
      if (deptFilter !== 'all') {
        filteredPOs = filteredPOs.filter(po => po.department === deptFilter);
      }
      
      // Supplier filter
      if (supplierFilter !== 'all') {
        filteredPOs = filteredPOs.filter(po => po.supplierName === supplierFilter);
      }
      
      // Date range filter
      if (dateFilter !== 'all') {
        const now = new Date();
        const startDate = new Date();
        
        switch(dateFilter) {
          case 'month':
            startDate.setMonth(now.getMonth() - 1);
            break;
          case 'quarter':
            startDate.setMonth(now.getMonth() - 3);
            break;
          case 'year':
            startDate.setFullYear(now.getFullYear() - 1);
            break;
        }
        
        filteredPOs = filteredPOs.filter(po => {
          const poDate = new Date(po.dateOrdered);
          return poDate >= startDate && poDate <= now;
        });
      }
      
      // Compliance filter
      if (complianceFilter !== 'all') {
        filteredPOs = filteredPOs.filter(po => {
          if (complianceFilter === 'compliant') {
            return po.complianceStatus === 'Compliant';
          } else {
            return po.complianceStatus === 'Non-Compliant';
          }
        });
      }
      
      // Calculate metrics from filtered data
      const deliveredPOs = filteredPOs.filter(po => po.status === 'Delivered');
      const pendingDeliveries = filteredPOs.filter(po => po.status === 'Pending' || po.status === 'Ordered').length;
      
      // On-time percentage
      let ontimeCount = 0;
      let totalDelivered = deliveredPOs.length;
      
      if (totalDelivered > 0) {
        ontimeCount = deliveredPOs.filter(po => po.delay <= 0).length;
      }
      
      const ontimePercentage = totalDelivered > 0 
        ? Math.round((ontimeCount / totalDelivered) * 100) 
        : 0;
      
      // Average lead time
      let totalLeadTime = 0;
      let poWithLeadTime = 0;
      
      deliveredPOs.forEach(po => {
        if (po.leadTime !== null) {
          totalLeadTime += po.leadTime;
          poWithLeadTime++;
        }
      });
      
      const avgLeadTime = poWithLeadTime > 0 
        ? Math.round(totalLeadTime / poWithLeadTime) 
        : 0;
      
      // Longest delay
      let longestDelay = 0;
      
      deliveredPOs.forEach(po => {
        if (po.delay !== null && po.delay > longestDelay) {
          longestDelay = po.delay;
        }
      });
      
      // Update metrics on dashboard
      document.getElementById('ontime-percentage').textContent = `${ontimePercentage}%`;
      document.getElementById('avg-lead-time').textContent = `${avgLeadTime} days`;
      document.getElementById('longest-delay').textContent = `${longestDelay} days`;
      document.getElementById('pending-deliveries').textContent = pendingDeliveries;
      
      // Populate compliance table
      const complianceTable = document.getElementById('compliance-table');
      complianceTable.innerHTML = '';
      
      filteredPOs.forEach(po => {
        const row = document.createElement('tr');
        
        // Determine if within threshold (30 days)
        const withinThreshold = po.delay === null 
          ? 'N/A' 
          : (po.delay <= 30 ? 'Yes' : 'No');
          
        const documentsComplete = po.documentsComplete ? 'Yes' : 'No';
        
        row.innerHTML = `
          <td>${po.poNumber}</td>
          <td>${po.department || '-'}</td>
          <td>${po.supplierName}</td>
          <td>${formatDate(po.dateNeeded)}</td>
          <td>${po.dateDelivered ? formatDate(po.dateDelivered) : '-'}</td>
          <td>${po.delay !== null ? (po.delay > 0 ? '+' + po.delay : po.delay) : '-'}</td>
          <td>${withinThreshold}</td>
          <td>${documentsComplete}</td>
        `;
        
        complianceTable.appendChild(row);
      });
      
      // If no records match the filter
      if (filteredPOs.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="8" style="text-align: center;">No records found matching the selected filters</td>';
        complianceTable.appendChild(row);
      }
      
      // Update main audit chart
      updateMainAuditChart(filteredPOs);
      
      // Store filtered data for detail charts
      window.filteredAuditData = filteredPOs;
    }
    
    // Update Main Audit Chart
    function updateMainAuditChart(filteredPOs) {
      const auditChartCtx = document.getElementById('auditChart').getContext('2d');
      
      // If chart already exists, destroy it properly
      if (window.auditChart && typeof window.auditChart.destroy === 'function') {
        window.auditChart.destroy();
      } else if (window.auditChart) {
        // If auditChart exists but destroy is not a function, reset it
        window.auditChart = null;
      }
      
      // Get data for compliance status breakdown
      const compliantCount = filteredPOs.filter(po => po.complianceStatus === 'Compliant').length;
      const nonCompliantCount = filteredPOs.filter(po => po.complianceStatus === 'Non-Compliant').length;
      const thresholdCount = filteredPOs.filter(po => po.complianceStatus === 'Within Threshold').length;
      const notApplicableCount = filteredPOs.filter(po => po.complianceStatus === 'Not Applicable' || !po.complianceStatus).length;
      
      // Create pie chart
      window.auditChart = new Chart(auditChartCtx, {
        type: 'pie',
        data: {
          labels: ['On Time', 'Within Threshold', 'Delayed', 'Not Delivered'],
          datasets: [{
            data: [compliantCount, thresholdCount, nonCompliantCount, notApplicableCount],
            backgroundColor: [
              'rgba(40, 167, 69, 0.7)', // green - compliant
              'rgba(255, 193, 7, 0.7)',  // yellow - threshold
              'rgba(220, 53, 69, 0.7)',  // red - non-compliant
              'rgba(108, 117, 125, 0.7)' // gray - not applicable
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(108, 117, 125, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Delivery Compliance Overview',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Update Detail Audit Charts
    function updateAuditDetailChart(chartType = 'delivery-performance') {
      const auditDetailChartCtx = document.getElementById('auditDetailChart').getContext('2d');
      const filteredPOs = window.filteredAuditData || purchaseOrderData;
      
      // If chart already exists, destroy it properly
      if (window.auditDetailChart && typeof window.auditDetailChart.destroy === 'function') {
        window.auditDetailChart.destroy();
      } else if (window.auditDetailChart) {
        // If auditDetailChart exists but destroy is not a function, reset it
        window.auditDetailChart = null;
      }
      
      // Configure chart based on selected type
      let chartConfig;
      
      switch(chartType) {
        case 'delivery-performance':
          chartConfig = createDeliveryPerformanceChart(filteredPOs);
          break;
        case 'compliance-trends':
          chartConfig = createComplianceTrendsChart(filteredPOs);
          break;
        case 'lead-time':
          chartConfig = createLeadTimeAnalysisChart(filteredPOs);
          break;
        case 'document-status':
          chartConfig = createDocumentStatusChart(filteredPOs);
          break;
        default:
          chartConfig = createDeliveryPerformanceChart(filteredPOs);
      }
      
      // Create chart
      window.auditDetailChart = new Chart(auditDetailChartCtx, chartConfig);
    }
    
    // Create Delivery Performance Chart
    function createDeliveryPerformanceChart(filteredPOs) {
      // Filter only delivered POs
      const deliveredPOs = filteredPOs.filter(po => po.status === 'Delivered');
      
      // Group by month
      const monthlyData = Array(12).fill().map(() => ({
        onTime: 0,
        delayed: 0,
        total: 0
      }));
      
      deliveredPOs.forEach(po => {
        if (po.dateDelivered) {
          const deliveryDate = new Date(po.dateDelivered);
          const month = deliveryDate.getMonth();
          
          monthlyData[month].total++;
          
          if (po.delay <= 0) {
            monthlyData[month].onTime++;
          } else {
            monthlyData[month].delayed++;
          }
        }
      });
      
      // Calculate percentages
      const onTimePercentages = monthlyData.map(data => 
        data.total > 0 ? Math.round((data.onTime / data.total) * 100) : 0
      );
      
      const delayedPercentages = monthlyData.map(data => 
        data.total > 0 ? Math.round((data.delayed / data.total) * 100) : 0
      );
      
      return {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [
            {
              label: 'On-Time Delivery (%)',
              data: onTimePercentages,
              backgroundColor: 'rgba(40, 167, 69, 0.7)',
              borderColor: 'rgba(40, 167, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'Delayed Delivery (%)',
              data: delayedPercentages,
              backgroundColor: 'rgba(220, 53, 69, 0.7)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Percentage (%)'
              },
              max: 100
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Monthly Delivery Performance',
              font: {
                size: 16
              }
            }
          }
        }
      };
    }
    
    // Create Compliance Trends Chart
    function createComplianceTrendsChart(filteredPOs) {
      // Filter only POs with status
      const posWithStatus = filteredPOs.filter(po => po.complianceStatus);
      
      // Group by supplier
      const suppliers = [...new Set(posWithStatus.map(po => po.supplierName))];
      const supplierData = suppliers.map(supplier => {
        const supplierPOs = posWithStatus.filter(po => po.supplierName === supplier);
        const compliantCount = supplierPOs.filter(po => po.complianceStatus === 'Compliant').length;
        const totalCount = supplierPOs.length;
        const complianceRate = totalCount > 0 ? Math.round((compliantCount / totalCount) * 100) : 0;
        
        return {
          supplier,
          complianceRate,
          totalOrders: totalCount
        };
      });
      
      // Sort by compliance rate (descending)
      supplierData.sort((a, b) => b.complianceRate - a.complianceRate);
      
      // Limit to top 10 suppliers by order volume
      const topSuppliers = supplierData
        .filter(s => s.totalOrders > 0)
        .slice(0, 10);
      
      return {
        type: 'horizontalBar',
        data: {
          labels: topSuppliers.map(s => s.supplier),
          datasets: [{
            label: 'On-Time Delivery Rate (%)',
            data: topSuppliers.map(s => s.complianceRate),
            backgroundColor: topSuppliers.map(s => 
              s.complianceRate >= 75 ? 'rgba(40, 167, 69, 0.7)' :
              s.complianceRate >= 50 ? 'rgba(255, 193, 7, 0.7)' :
              'rgba(220, 53, 69, 0.7)'
            ),
            borderColor: topSuppliers.map(s => 
              s.complianceRate >= 75 ? 'rgba(40, 167, 69, 1)' :
              s.complianceRate >= 50 ? 'rgba(255, 193, 7, 1)' :
              'rgba(220, 53, 69, 1)'
            ),
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'On-Time Rate (%)'
              },
              max: 100
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Supplier Compliance Rate',
              font: {
                size: 16
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const supplier = topSuppliers[context.dataIndex];
                  return `${context.raw}% on-time (${supplier.totalOrders} orders)`;
                }
              }
            }
          }
        }
      };
    }
    
    // Create Lead Time Analysis Chart
    function createLeadTimeAnalysisChart(filteredPOs) {
      // Filter only delivered POs with lead time
      const posWithLeadTime = filteredPOs.filter(po => po.status === 'Delivered' && po.leadTime !== null);
      
      // Group by lead time ranges
      const leadTimeRanges = [
        { label: '0-7 days', min: 0, max: 7, count: 0 },
        { label: '8-14 days', min: 8, max: 14, count: 0 },
        { label: '15-30 days', min: 15, max: 30, count: 0 },
        { label: '31-60 days', min: 31, max: 60, count: 0 },
        { label: '61+ days', min: 61, max: Infinity, count: 0 }
      ];
      
      posWithLeadTime.forEach(po => {
        const range = leadTimeRanges.find(r => po.leadTime >= r.min && po.leadTime <= r.max);
        if (range) {
          range.count++;
        }
      });
      
      // Calculate department averages if there are multiple departments
      const departments = [...new Set(posWithLeadTime.map(po => po.department).filter(Boolean))];
      let departmentData = [];
      
      if (departments.length > 1) {
        departmentData = departments.map(dept => {
          const deptPOs = posWithLeadTime.filter(po => po.department === dept);
          const totalLeadTime = deptPOs.reduce((sum, po) => sum + po.leadTime, 0);
          const avgLeadTime = deptPOs.length > 0 ? Math.round(totalLeadTime / deptPOs.length) : 0;
          
          return {
            department: dept,
            avgLeadTime
          };
        });
        
        // Sort by average lead time (ascending)
        departmentData.sort((a, b) => a.avgLeadTime - b.avgLeadTime);
      }
      
      // Decide which chart to show based on data
      if (departmentData.length > 1) {
        // Show department comparison
        return {
          type: 'horizontalBar',
          data: {
            labels: departmentData.map(d => d.department),
            datasets: [{
              label: 'Average Lead Time (days)',
              data: departmentData.map(d => d.avgLeadTime),
              backgroundColor: 'rgba(23, 162, 184, 0.7)',
              borderColor: 'rgba(23, 162, 184, 1)',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: 'Lead Time by Department',
                font: {
                  size: 16
                }
              }
            }
          }
        };
      } else {
        // Show lead time distribution
        return {
          type: 'bar',
          data: {
            labels: leadTimeRanges.map(r => r.label),
            datasets: [{
              label: 'Number of Orders',
              data: leadTimeRanges.map(r => r.count),
              backgroundColor: 'rgba(23, 162, 184, 0.7)',
              borderColor: 'rgba(23, 162, 184, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Purchase Orders'
                }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Lead Time Distribution',
                font: {
                  size: 16
                }
              }
            }
          }
        };
      }
    }
    
    // Create Document Status Chart
    function createDocumentStatusChart(filteredPOs) {
      // Filter POs with document info
      const posWithDocs = filteredPOs.filter(po => po.documents);
      
      // Count document statuses
      const documentTypes = ['pr', 'po', 'deliveryReceipt', 'inspectionReport'];
      const documentLabels = ['PR Document', 'PO Document', 'Delivery Receipt', 'Inspection Report'];
      
      const documentStatusCounts = documentTypes.map((docType, index) => {
        const verifiedCount = posWithDocs.filter(po => po.documents[docType] === 'Verified').length;
        const receivedCount = posWithDocs.filter(po => po.documents[docType] === 'Received').length;
        const pendingCount = posWithDocs.filter(po => po.documents[docType] === 'Pending').length;
        const notRequiredCount = posWithDocs.filter(po => po.documents[docType] === 'Not Required').length;
        
        return {
          label: documentLabels[index],
          verified: verifiedCount,
          received: receivedCount,
          pending: pendingCount,
          notRequired: notRequiredCount
        };
      });
      
      return {
        type: 'bar',
        data: {
          labels: documentLabels,
          datasets: [
            {
              label: 'Verified',
              data: documentStatusCounts.map(doc => doc.verified),
              backgroundColor: 'rgba(40, 167, 69, 0.7)',
              borderColor: 'rgba(40, 167, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'Received',
              data: documentStatusCounts.map(doc => doc.received),
              backgroundColor: 'rgba(23, 162, 184, 0.7)',
              borderColor: 'rgba(23, 162, 184, 1)',
              borderWidth: 1
            },
            {
              label: 'Pending',
              data: documentStatusCounts.map(doc => doc.pending),
              backgroundColor: 'rgba(255, 193, 7, 0.7)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 1
            },
            {
              label: 'Not Required',
              data: documentStatusCounts.map(doc => doc.notRequired),
              backgroundColor: 'rgba(108, 117, 125, 0.7)',
              borderColor: 'rgba(108, 117, 125, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Supporting Document Status',
              font: {
                size: 16
              }
            }
          }
        }
      };
    }
    
    // Initialize tabs for Purchase Orders page
    function initializePOTabs() {
      const poTabs = document.querySelectorAll('.tab[data-po-tab]');
      const poTabContents = document.querySelectorAll('#purchase-orders .tab-content');
      
      poTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-po-tab');
          
          // Hide all tab contents
          poTabContents.forEach(content => {
            content.classList.remove('active');
          });
          
          // Show selected tab content
          document.getElementById(tabId).classList.add('active');
          
          // Update active tab
          poTabs.forEach(t => {
            t.classList.remove('active');
          });
          
          tab.classList.add('active');
          
          // Update content based on the active tab
          if (tabId === 'delivery-tracker') {
            populateDeliveryTracker();
          } else if (tabId === 'audit-dashboard') {
            updateAuditDashboard();
          }
        });
      });
    }
    
    // Initialize filters for Audit Dashboard
    function initializeAuditFilters() {
      // Department filter
      const deptFilter = document.getElementById('audit-filter-dept');
      if (deptFilter) {
        deptFilter.innerHTML = '<option value="all">All Departments</option>';
        
        // Get unique departments from requisitions
        const departments = [...new Set(requisitionData.map(req => req.office))];
        
        departments.forEach(dept => {
          if (dept) {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            deptFilter.appendChild(option);
          }
        });
        
        deptFilter.addEventListener('change', () => {
          updateAuditDashboard();
          updateAuditDetailChart();
        });
      }
      
      // Other filters
      const filterIds = ['audit-filter-supplier', 'audit-filter-date', 'audit-filter-compliance'];
      
      filterIds.forEach(id => {
        const filter = document.getElementById(id);
        if (filter) {
          filter.addEventListener('change', () => {
            updateAuditDashboard();
            updateAuditDetailChart();
          });
        }
      });
      
      // Delivery tracker filter
      const deliveryFilter = document.getElementById('delivery-filter');
      if (deliveryFilter) {
        deliveryFilter.addEventListener('change', populateDeliveryTracker);
      }
      
      // Export data button
      const exportBtn = document.getElementById('export-audit-data');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          // Set default filename with current date
          const today = new Date();
          const dateStr = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
          document.getElementById('export-filename').value = `audit_report_${dateStr}`;
          
          // Open export modal
          openModal(document.getElementById('exportModal'));
        });
      }
      
      // Export modal buttons
      const downloadExportBtn = document.getElementById('download-export-btn');
      const cancelExportBtn = document.getElementById('cancel-export-btn');
      
      if (downloadExportBtn) {
        downloadExportBtn.addEventListener('click', () => {
          exportAuditData();
          closeModal(document.getElementById('exportModal'));
        });
      }
      
      if (cancelExportBtn) {
        cancelExportBtn.addEventListener('click', () => {
          closeModal(document.getElementById('exportModal'));
        });
      }
      
      // Initialize audit detail chart tabs
      const auditChartTabs = document.querySelectorAll('.tab[data-audit-chart]');
      auditChartTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Update active tab
          auditChartTabs.forEach(t => {
            t.classList.remove('active');
          });
          tab.classList.add('active');
          
          // Update chart based on selected tab
          const chartType = tab.getAttribute('data-audit-chart');
          updateAuditDetailChart(chartType);
        });
      });
    }

    // User roles and permissions
    const userRoles = {
      admin: {
        name: "Administrator",
        permissions: ["view", "create", "edit", "delete", "approve", "audit"],
        description: "Full system access with all privileges"
      },
      procurement: {
        name: "Procurement Officer",
        permissions: ["view", "create", "edit", "approve"],
        description: "Manages purchase orders and supplier relationships"
      },
      requester: {
        name: "Requisition Requester",
        permissions: ["view", "create"],
        description: "Can create and view requisitions"
      },
      auditor: {
        name: "System Auditor",
        permissions: ["view", "audit"],
        description: "Can view all records and access audit features"
      },
      viewer: {
        name: "Viewer",
        permissions: ["view"],
        description: "Read-only access to system data"
      }
    };
    
    // Current user role (default: admin)
    let currentUserRole = "admin";
    
    // Set user interface based on role
    function setUserInterface(role) {
      currentUserRole = role;
      
      // Update header display
      document.getElementById('header-user-name').textContent = "Admin User";
      document.getElementById('header-user-role').textContent = userRoles[role].name;
      
      // Show/hide menu items based on role
      document.querySelectorAll('.menu-item').forEach(item => {
        const allowedRoles = item.getAttribute('data-role').split(',');
        
        if (allowedRoles.includes('all') || allowedRoles.includes(role)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
      
      // Handle action buttons based on permissions
      const userPermissions = userRoles[role].permissions;
      
      // Create/Add buttons
      const createButtons = document.querySelectorAll('#createRequisitionBtn, #createRequisitionBtn2, #addSupplierBtn, #createPurchaseOrderBtn');
      createButtons.forEach(btn => {
        btn.style.display = userPermissions.includes('create') ? 'inline-block' : 'none';
      });
      
      // Edit buttons will be handled dynamically when tables are populated
      
      // Export button (audit permission)
      const exportBtn = document.getElementById('export-audit-data');
      if (exportBtn) {
        exportBtn.style.display = userPermissions.includes('audit') ? 'inline-block' : 'none';
      }
      
      // Handle special case for auditors - focus on audit dashboard
      if (role === 'auditor') {
        // Switch to Purchase Orders page
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById('purchase-orders').classList.add('active');
        
        // Activate audit dashboard tab
        document.querySelectorAll('.tab[data-po-tab]').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelector('.tab[data-po-tab="audit-dashboard"]').classList.add('active');
        
        // Show audit dashboard content
        document.querySelectorAll('#purchase-orders .tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById('audit-dashboard').classList.add('active');
        
        // Update menu item highlighting
        document.querySelectorAll('.menu-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelector('.menu-item[data-page="purchase-orders"]').classList.add('active');
      }
    }
    
    // Apply role-based restrictions to tables
    function applyRoleRestrictionsToTables() {
      const userPermissions = userRoles[currentUserRole].permissions;
      const canEdit = userPermissions.includes('edit');
      const canDelete = userPermissions.includes('delete');
      
      // Hide edit/delete buttons if user doesn't have permission
      document.querySelectorAll('.edit-req, .edit-supplier, .edit-staff, .edit-po').forEach(btn => {
        btn.style.display = canEdit ? 'inline-block' : 'none';
      });
      
      document.querySelectorAll('.delete-req, .delete-supplier, .delete-staff, .delete-po').forEach(btn => {
        btn.style.display = canDelete ? 'inline-block' : 'none';
      });
      
      // Also apply to status change buttons (requires edit permission)
      document.querySelectorAll('.status-change').forEach(btn => {
        btn.style.display = canEdit ? 'inline-block' : 'none';
      });
      
      // For auditor role, emphasize compliance information
      if (currentUserRole === 'auditor') {
        document.querySelectorAll('.badge-danger').forEach(badge => {
          badge.style.fontWeight = 'bold';
          badge.style.padding = '6px 12px';
        });
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      loadDataFromLocalStorage();
      initializeTables();
      
      // Initialize charts before trying to update them
      initCharts();
      
      // Initialize additional components for audit features
      populateReceivingOfficerDropdown();
      initializePOTabs();
      initializeAuditFilters();
      populateDeliveryTracker();
      updateAuditDashboard();
      updateAuditDetailChart();
      
      // Set up role selector
      const roleSelector = document.getElementById('role-selector');
      if (roleSelector) {
        roleSelector.addEventListener('change', function() {
          const selectedRole = this.value;
          setUserInterface(selectedRole);
          
          // Reapply role restrictions to tables
          setTimeout(applyRoleRestrictionsToTables, 100);
        });
      }
      
      // Initialize with default role (admin)
      setUserInterface(currentUserRole);
    });
    
    // Populate Monthly Requisitions
    function populateMonthlyRequisitions() {
      const monthlyRequisitionsTable = document.getElementById('monthly-requisitions');
      monthlyRequisitionsTable.innerHTML = '';
      
      const selectedMonth = parseInt(monthSelector.value);
      
      const monthlyData = requisitionData.filter(req => {
        const date = new Date(req.dateReceived);
        return date.getMonth() === selectedMonth;
      });
      
      if (monthlyData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" style="text-align: center;">No requisitions found for this month</td>';
        monthlyRequisitionsTable.appendChild(row);
        return;
      }
      
      monthlyData.forEach(req => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td><span class="req-number-link" data-id="${req.id}">${req.id}</span></td>
          <td>${req.office}</td>
          <td>${req.type}</td>
          <td>${formatDate(req.dateReceived)}</td>
          <td>${req.purpose}</td>
          <td>${req.accountableOfficer}</td>
          <td>
            <span class="badge badge-${getBadgeClass(req.status)}">${req.status}</span>
          </td>
        `;
        
        monthlyRequisitionsTable.appendChild(row);
      });
      
      // Add event listeners for requisition number links
      document.querySelectorAll('.req-number-link').forEach(link => {
        link.addEventListener('click', () => {
          const id = link.getAttribute('data-id');
          viewRequisitionDetails(id);
        });
      });
    }
    
    // Filter Requisitions by Dashboard Filter
    function filterRequisitionsByDashboardFilter() {
      const filterValue = dashboardFilter.value;
      let filteredRequisitions = [];
      
      if (filterValue === 'all') {
        filteredRequisitions = requisitionData;
      } else if (filterValue === 'monthly') {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        filteredRequisitions = requisitionData.filter(req => {
          const date = new Date(req.dateReceived);
          return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        });
      } else if (filterValue === '1st-semester') {
        // First semester: July to December
        filteredRequisitions = requisitionData.filter(req => {
          const date = new Date(req.dateReceived);
          return date.getMonth() >= 6 && date.getMonth() <= 11;
        });
      } else if (filterValue === '2nd-semester') {
        // Second semester: January to June
        filteredRequisitions = requisitionData.filter(req => {
          const date = new Date(req.dateReceived);
          return date.getMonth() >= 0 && date.getMonth() <= 5;
        });
      }
      
      return filteredRequisitions;
    }
    
    // Charts
    let requisitionsChart;
    let reportChart;
    
    function initCharts() {
      // Requisitions Chart (Dashboard)
      const requisitionsChartCtx = document.getElementById('requisitionsChart').getContext('2d');
      requisitionsChart = new Chart(requisitionsChartCtx, {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [
            {
              label: 'Consumable',
              data: getMonthlyRequisitionsByType('Consumable'),
              backgroundColor: 'rgba(230, 57, 70, 0.7)',
              borderColor: 'rgba(230, 57, 70, 1)',
              borderWidth: 1
            },
            {
              label: 'Non-Consumable',
              data: getMonthlyRequisitionsByType('Non-Consumable'),
              backgroundColor: 'rgba(29, 53, 87, 0.7)',
              borderColor: 'rgba(29, 53, 87, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Requisitions'
              }
            }
          }
        }
      });
      
      // Report Chart
      const reportChartCtx = document.getElementById('reportChart').getContext('2d');
      reportChart = new Chart(reportChartCtx, {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [
            {
              label: 'Monthly Requisitions',
              data: getMonthlyRequisitionsCount(),
              backgroundColor: 'rgba(230, 57, 70, 0.7)',
              borderColor: 'rgba(230, 57, 70, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Requisitions'
              }
            }
          }
        }
      });
    }
    
    function updateCharts() {
      // Check if charts are initialized
      if (!requisitionsChart || !reportChart) {
        console.warn("Charts not initialized. Initializing now...");
        initCharts();
        return;
      }

      const filteredRequisitions = filterRequisitionsByDashboardFilter();
      
      // Update Requisitions Chart - with proper error checking
      if (requisitionsChart && requisitionsChart.data && requisitionsChart.data.datasets && 
          requisitionsChart.data.datasets.length >= 2) {
        requisitionsChart.data.datasets[0].data = getMonthlyRequisitionsByType('Consumable', filteredRequisitions);
        requisitionsChart.data.datasets[1].data = getMonthlyRequisitionsByType('Non-Consumable', filteredRequisitions);
        requisitionsChart.update();
      }
      
      // Update Report Chart based on selected report type
      if (!reportChart || !reportChart.data) {
        console.warn("Report chart not properly initialized");
        return;
      }
      
      const reportTypeValue = reportType.value;
      
      if (reportTypeValue === 'monthly') {
        reportChart.data.labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        reportChart.data.datasets = [{
          label: 'Monthly Requisitions',
          data: getMonthlyRequisitionsCount(),
          backgroundColor: 'rgba(230, 57, 70, 0.7)',
          borderColor: 'rgba(230, 57, 70, 1)',
          borderWidth: 1
        }];
      } else if (reportTypeValue === 'department') {
        const offices = [...new Set(requisitionData.map(req => req.office))];
        const officeCounts = offices.map(office => {
          return requisitionData.filter(req => req.office === office).length;
        });
        
        reportChart.data.labels = offices;
        reportChart.data.datasets = [{
          label: 'Requisitions by Office',
          data: officeCounts,
          backgroundColor: 'rgba(230, 57, 70, 0.7)',
          borderColor: 'rgba(230, 57, 70, 1)',
          borderWidth: 1
        }];
      } else if (reportTypeValue === 'status') {
        const statuses = ['Still Processing', 'Ordered', 'Delivered'];
        const statusCounts = statuses.map(status => {
          return requisitionData.filter(req => req.status === status).length;
        });
        
        reportChart.data.labels = statuses;
        reportChart.data.datasets = [{
          label: 'Requisitions by Status',
          data: statusCounts,
          backgroundColor: [
            'rgba(255, 193, 7, 0.7)',
            'rgba(23, 162, 184, 0.7)',
            'rgba(40, 167, 69, 0.7)'
          ],
          borderColor: [
            'rgba(255, 193, 7, 1)',
            'rgba(23, 162, 184, 1)',
            'rgba(40, 167, 69, 1)'
          ],
          borderWidth: 1
        }];
      } else if (reportTypeValue === 'type') {
        const types = ['Consumable', 'Non-Consumable'];
        const typeCounts = types.map(type => {
          return requisitionData.filter(req => req.type === type).length;
        });
        
        reportChart.data.labels = types;
        reportChart.data.datasets = [{
          label: 'Requisitions by Type',
          data: typeCounts,
          backgroundColor: [
            'rgba(230, 57, 70, 0.7)',
            'rgba(29, 53, 87, 0.7)'
          ],
          borderColor: [
            'rgba(230, 57, 70, 1)',
            'rgba(29, 53, 87, 1)'
          ],
          borderWidth: 1
        }];
      }
      
      reportChart.update();
    }
    
    // Helper Functions
    function formatDate(dateString) {
      if (dateString === 'N/A') return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    function getBadgeClass(status) {
      switch (status) {
        case 'Still Processing':
          return 'processing';
        case 'Ordered':
          return 'ordered';
        case 'Delivered':
          return 'delivered';
        case 'Cancelled':
          return 'danger';
        default:
          return '';
      }
    }
    
    function getMonthlyRequisitionsCount(reqs = requisitionData) {
      const monthlyCount = Array(12).fill(0);
      
      reqs.forEach(req => {
        if (req.dateReceived === 'N/A') return;
        
        const date = new Date(req.dateReceived);
        const month = date.getMonth();
        monthlyCount[month]++;
      });
      
      return monthlyCount;
    }
    
    function getMonthlyRequisitionsByType(type, reqs = requisitionData) {
      const monthlyCount = Array(12).fill(0);
      
      const filteredReqs = reqs.filter(req => req.type === type);
      
      filteredReqs.forEach(req => {
        if (req.dateReceived === 'N/A') return;
        
        const date = new Date(req.dateReceived);
        const month = date.getMonth();
        monthlyCount[month]++;
      });
      
      return monthlyCount;
    }
    
    // Change Requisition Status
    function changeRequisitionStatus(id, newStatus) {
      const requisition = requisitionData.find(req => req.id === id);
      
      if (requisition) {
        requisition.status = newStatus;
        
        // Save to local storage for auto-save functionality
        saveDataToLocalStorage();
        
        populateRequisitionTables();
        populateMonthlyRequisitions();
        updateCharts();
        updateDashboardMetrics();
      }
    }
    
    // Delete Requisition
    function deleteRequisition(id) {
      const index = requisitionData.findIndex(req => req.id === id);
      
      if (index !== -1) {
        requisitionData.splice(index, 1);
        
        // Save to local storage for auto-save functionality
        saveDataToLocalStorage();
        
        populateRequisitionTables();
        populateMonthlyRequisitions();
        updateCharts();
        updateDashboardMetrics();
      }
    }
    
    // Delete Supplier
    function deleteSupplier(id) {
      const index = supplierData.findIndex(sup => sup.id === id);
      
      if (index !== -1) {
        supplierData.splice(index, 1);
        
        // Save to local storage for auto-save functionality
        saveDataToLocalStorage();
        
        populateSuppliersTable();
        updateDashboardMetrics();
      }
    }
    
    // Edit Supplier
    function editSupplier(id) {
      const supplier = supplierData.find(sup => sup.id === id);
      
      if (supplier) {
        // Fill form with supplier data
        document.getElementById('supplier-company').value = supplier.company;
        document.getElementById('supplier-contact').value = supplier.contact;
        document.getElementById('supplier-email').value = supplier.email;
        document.getElementById('supplier-phone').value = supplier.phone;
        document.getElementById('supplier-tin').value = supplier.tin;
        document.getElementById('supplier-vat').value = supplier.vat;
        document.getElementById('supplier-category').value = supplier.category;
        document.getElementById('supplier-status').value = supplier.status;
        
        // Store editing ID for save function
        window.editingSupplierID = id;
        
        // Update modal title
        document.querySelector('#supplierModal .modal-header h2').textContent = 'Edit Supplier';
        
        // Open the modal
        openModal(supplierModal);
      }
    }
    
    // Export Audit Data
    function exportAuditData() {
      const format = document.getElementById('export-format').value;
      const content = document.getElementById('export-content').value;
      const includeCharts = document.getElementById('export-include-charts').checked;
      const filename = document.getElementById('export-filename').value || 'audit_report';
      
      // Get filtered data based on current filters or all data
      let exportData = [];
      if (content === 'current' && window.filteredAuditData) {
        exportData = window.filteredAuditData;
      } else {
        exportData = purchaseOrderData;
      }
      
      // Process data according to format
      switch (format) {
        case 'csv':
          exportAsCSV(exportData, filename);
          break;
        case 'excel':
          exportAsExcel(exportData, filename, includeCharts);
          break;
        case 'pdf':
          exportAsPDF(exportData, filename, includeCharts);
          break;
        case 'json':
          exportAsJSON(exportData, filename);
          break;
      }
    }
    
    // Export as CSV
    function exportAsCSV(data, filename) {
      // Headers
      let csvContent = "PO Number,Supplier,Department,Date Ordered,Date Needed,Date Delivered,Lead Time,Delay,Compliance Status,Documents Complete\n";
      
      // Add rows
      data.forEach(po => {
        const row = [
          po.poNumber,
          po.supplierName,
          po.department || '',
          po.dateOrdered || '',
          po.dateNeeded || '',
          po.dateDelivered || '',
          po.leadTime !== null ? po.leadTime : '',
          po.delay !== null ? po.delay : '',
          po.complianceStatus || '',
          po.documentsComplete ? 'Yes' : 'No'
        ];
        
        // Escape any commas in the data
        const escapedRow = row.map(field => {
          if (field.toString().includes(',')) {
            return `"${field}"`;
          }
          return field;
        });
        
        csvContent += escapedRow.join(',') + '\n';
      });
      
      // Create and trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.setAttribute('download', `${filename}.csv`);
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Export as Excel
    function exportAsExcel(data, filename, includeCharts) {
      // For Excel export, we'll simulate it by creating a CSV
      // In a real-world app, you would use a library like SheetJS
      alert('Excel export functionality would be implemented with SheetJS in a real-world application. Exporting as CSV instead.');
      exportAsCSV(data, filename);
    }
    
    // Export as PDF
    function exportAsPDF(data, filename, includeCharts) {
      // Create a summary message
      const compliantCount = data.filter(po => po.complianceStatus === 'Compliant').length;
      const totalCount = data.length;
      const complianceRate = totalCount > 0 ? Math.round((compliantCount / totalCount) * 100) : 0;
      
      const message = `
        Audit Report Summary
        -------------------
        Total Purchase Orders: ${totalCount}
        On-time Deliveries: ${compliantCount} (${complianceRate}%)
        Average Lead Time: ${calculateAvgLeadTime(data)} days
        
        This is a simulated PDF export. In a real application, this would generate
        a formatted PDF document including tables and charts.
        
        Export Date: ${new Date().toLocaleString()}
      `;
      
      // Alert the user (in a real app, this would generate a PDF)
      alert(message);
    }
    
    // Export as JSON
    function exportAsJSON(data, filename) {
      // Create a simplified version of the data for export
      const exportData = data.map(po => {
        return {
          poNumber: po.poNumber,
          supplier: po.supplierName,
          department: po.department || '',
          dateOrdered: po.dateOrdered || '',
          dateNeeded: po.dateNeeded || '',
          dateDelivered: po.dateDelivered || '',
          leadTime: po.leadTime,
          delay: po.delay,
          complianceStatus: po.complianceStatus,
          documentsComplete: po.documentsComplete,
          documentStatus: po.documents || {}
        };
      });
      
      // Create and trigger download
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.setAttribute('download', `${filename}.json`);
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Helper function to calculate average lead time
    function calculateAvgLeadTime(data) {
      const posWithLeadTime = data.filter(po => po.leadTime !== null);
      if (posWithLeadTime.length === 0) return 0;
      
      const totalLeadTime = posWithLeadTime.reduce((sum, po) => sum + po.leadTime, 0);
      return Math.round(totalLeadTime / posWithLeadTime.length);
    }
    
    // Event Listeners
    monthSelector.addEventListener('change', populateMonthlyRequisitions);
    reportType.addEventListener('change', updateCharts);
    dashboardFilter.addEventListener('change', () => {
      updateCharts();
      updateDashboardMetrics();
    });
    
    // Staff Management Event Listeners
    document.addEventListener('click', (e) => {
      // Edit staff
      if (e.target.classList.contains('edit-staff')) {
        const id = e.target.getAttribute('data-id');
        
        if (userRoles[currentUserRole].permissions.includes('edit')) {
          editStaff(id);
        } else {
          alert('You do not have permission to edit staff. Please contact an administrator.');
        }
      }
      
      // Delete staff
      if (e.target.classList.contains('delete-staff')) {
        const id = e.target.getAttribute('data-id');
        
        if (userRoles[currentUserRole].permissions.includes('delete')) {
          if (confirm('Are you sure you want to delete this staff member?')) {
            deleteStaff(id);
          }
        } else {
          alert('You do not have permission to delete staff. Please contact an administrator.');
        }
      }
    });
    
    // Status Change and Delete Event Listeners
    document.addEventListener('click', (e) => {
      // Status Change - check for edit permission
      if (e.target.classList.contains('status-change')) {
        const id = e.target.getAttribute('data-id');
        const newStatus = e.target.getAttribute('data-status');
        
        if (userRoles[currentUserRole].permissions.includes('edit')) {
          changeRequisitionStatus(id, newStatus);
        } else {
          alert('You do not have permission to change item status. Please contact an administrator or procurement officer.');
        }
      }
      
      // Delete Requisition - check for delete permission
      if (e.target.classList.contains('delete-req')) {
        const id = e.target.getAttribute('data-id');
        
        if (userRoles[currentUserRole].permissions.includes('delete')) {
          if (confirm('Are you sure you want to delete this requisition?')) {
            deleteRequisition(id);
          }
        } else {
          alert('You do not have permission to delete items. Please contact an administrator.');
        }
      }
      
      // Delete Supplier - check for delete permission
      if (e.target.classList.contains('delete-supplier')) {
        const id = e.target.getAttribute('data-id');
        
        if (userRoles[currentUserRole].permissions.includes('delete')) {
          if (confirm('Are you sure you want to delete this supplier?')) {
            deleteSupplier(id);
          }
        } else {
          alert('You do not have permission to delete suppliers. Please contact an administrator.');
        }
      }
      
      // Edit Supplier - check for edit permission
      if (e.target.classList.contains('edit-supplier')) {
        const id = e.target.getAttribute('data-id');
        
        if (userRoles[currentUserRole].permissions.includes('edit')) {
          editSupplier(id);
        } else {
          alert('You do not have permission to edit suppliers. Please contact an administrator.');
        }
      }
      
      // Auto-save any form changes
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
        // Set a timeout to avoid saving on every keystroke
        if (window.autoSaveTimeout) {
          clearTimeout(window.autoSaveTimeout);
        }
        window.autoSaveTimeout = setTimeout(() => {
          saveDataToLocalStorage();
        }, 1000);
      }
      
      // View Requisition Details
      if (e.target.classList.contains('req-number-link') || e.target.classList.contains('view-req') || 
         (e.target.parentElement && e.target.parentElement.classList.contains('view-req'))) {
        const button = e.target.classList.contains('req-number-link') ? e.target : 
                      (e.target.classList.contains('view-req') ? e.target : e.target.parentElement);
        const id = button.getAttribute('data-id');
        viewRequisitionDetails(id);
      }
      
      // Edit Requisition - check for edit permission
      if (e.target.classList.contains('edit-req') || (e.target.parentElement && e.target.parentElement.classList.contains('edit-req'))) {
        const button = e.target.classList.contains('edit-req') ? e.target : e.target.parentElement;
        const id = button.getAttribute('data-id');
        
        if (userRoles[currentUserRole].permissions.includes('edit')) {
          editRequisition(id);
        } else {
          alert('You do not have permission to edit items. You can view the details but not make changes.');
          viewRequisitionDetails(id);
        }
      }
    });
    
    // End of event listener
  </script>
  <script src="suppliers.js"></script>
</body>

</html>